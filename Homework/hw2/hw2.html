<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yi Fan (Eric) Wang">
<meta name="dcterms.date" content="2026-02-14">

<title>Homework 2 — Data Scraping, APIs and Advanced Regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="hw2_files/libs/clipboard/clipboard.min.js"></script>
<script src="hw2_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="hw2_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="hw2_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="hw2_files/libs/quarto-html/popper.min.js"></script>
<script src="hw2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="hw2_files/libs/quarto-html/anchor.min.js"></script>
<link href="hw2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="hw2_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="hw2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="hw2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="hw2_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="hw2_files/libs/quarto-contrib/live-runtime/live-runtime.js" type="module"></script>
<link href="hw2_files/libs/quarto-contrib/live-runtime/live-runtime.css" rel="stylesheet">
<script type="module" src="hw2_files/libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="hw2_files/libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-goals" id="toc-learning-goals" class="nav-link active" data-scroll-target="#learning-goals">Learning Goals</a></li>
  <li><a href="#assignment-description" id="toc-assignment-description" class="nav-link" data-scroll-target="#assignment-description">Assignment Description</a></li>
  <li><a href="#data-acquisition-and-wrangling" id="toc-data-acquisition-and-wrangling" class="nav-link" data-scroll-target="#data-acquisition-and-wrangling">Data Acquisition and Wrangling</a>
  <ul class="collapse">
  <li><a href="#points-obtain-two-datasets-life-expectancy-via-api-and-alcohol-consumption-via-web-scraping." id="toc-points-obtain-two-datasets-life-expectancy-via-api-and-alcohol-consumption-via-web-scraping." class="nav-link" data-scroll-target="#points-obtain-two-datasets-life-expectancy-via-api-and-alcohol-consumption-via-web-scraping.">1. (15 points) Obtain two datasets: life expectancy (via API) and alcohol consumption (via web scraping).</a>
  <ul class="collapse">
  <li><a href="#a." id="toc-a." class="nav-link" data-scroll-target="#a.">1a.</a></li>
  <li><a href="#b." id="toc-b." class="nav-link" data-scroll-target="#b.">1b.</a></li>
  <li><a href="#c." id="toc-c." class="nav-link" data-scroll-target="#c.">1c.</a></li>
  <li><a href="#d." id="toc-d." class="nav-link" data-scroll-target="#d.">1d.</a></li>
  <li><a href="#e." id="toc-e." class="nav-link" data-scroll-target="#e.">1e.</a></li>
  <li><a href="#f." id="toc-f." class="nav-link" data-scroll-target="#f.">1f.</a></li>
  <li><a href="#g." id="toc-g." class="nav-link" data-scroll-target="#g.">1g.</a></li>
  </ul></li>
  <li><a href="#points" id="toc-points" class="nav-link" data-scroll-target="#points">2. (4 points)</a></li>
  <li><a href="#points-1" id="toc-points-1" class="nav-link" data-scroll-target="#points-1">3. (4 points)</a></li>
  </ul></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization">Visualization</a>
  <ul class="collapse">
  <li><a href="#points-2" id="toc-points-2" class="nav-link" data-scroll-target="#points-2">4. (15 points)</a>
  <ul class="collapse">
  <li><a href="#a.-1" id="toc-a.-1" class="nav-link" data-scroll-target="#a.-1">4a.</a></li>
  <li><a href="#b.-1" id="toc-b.-1" class="nav-link" data-scroll-target="#b.-1">4b.</a></li>
  <li><a href="#c.-1" id="toc-c.-1" class="nav-link" data-scroll-target="#c.-1">4c.</a></li>
  <li><a href="#d.-1" id="toc-d.-1" class="nav-link" data-scroll-target="#d.-1">4d.</a></li>
  <li><a href="#e.-1" id="toc-e.-1" class="nav-link" data-scroll-target="#e.-1">4e.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#advanced-regression" id="toc-advanced-regression" class="nav-link" data-scroll-target="#advanced-regression">Advanced Regression</a>
  <ul class="collapse">
  <li><a href="#points-3" id="toc-points-3" class="nav-link" data-scroll-target="#points-3">5. (8 points)</a>
  <ul class="collapse">
  <li><a href="#a.-2" id="toc-a.-2" class="nav-link" data-scroll-target="#a.-2">5a.</a></li>
  <li><a href="#b.-2" id="toc-b.-2" class="nav-link" data-scroll-target="#b.-2">5b.</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Homework 2 — Data Scraping, APIs and Advanced Regression</h1>
<p class="subtitle lead">JSC370 (Winter 2026)</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Yi Fan (Eric) Wang </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 14, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="learning-goals" class="level1">
<h1>Learning Goals</h1>
<ul>
<li>Use an API, scrape, wrangle, and get familiar different datasets.</li>
<li>Make visualizations</li>
<li>Conduct GAM regression modeling and compare to linear regression</li>
</ul>
</section>
<section id="assignment-description" class="level1">
<h1>Assignment Description</h1>
<p>For this assignment, we will be analyzing data on life expectancy and alcohol consumption. The learning objectives are to conduct data wrangling and visualization keeping key questions in mind. We will also do a regression analysis.</p>
<p>The primary questions of interest are:</p>
<ul>
<li>Is there an association between life expectancy and alcohol consumption?</li>
<li>How have life expectancy and alcohol consumption changed over time?</li>
<li>Do other country specific factors such as per capita gross domestic product or population play a role in the relationship between alcohol consumption and life expectancy?</li>
</ul>
</section>
<section id="data-acquisition-and-wrangling" class="level1">
<h1>Data Acquisition and Wrangling</h1>
<section id="points-obtain-two-datasets-life-expectancy-via-api-and-alcohol-consumption-via-web-scraping." class="level2">
<h2 class="anchored" data-anchor-id="points-obtain-two-datasets-life-expectancy-via-api-and-alcohol-consumption-via-web-scraping.">1. (15 points) Obtain two datasets: life expectancy (via API) and alcohol consumption (via web scraping).</h2>
<p>For life expectancy, population, and GDP: Use the World Bank API to fetch the following indicators:</p>
<ul>
<li>SP.DYN.LE00.IN - Life expectancy at birth, total (years)</li>
<li>SP.POP.TOTL - Population, total</li>
<li>NY.GDP.PCAP.CD - GDP per capita (current US$)</li>
</ul>
<p>You will need to:</p>
<ul>
<li>Parse the nested JSON response into a clean DataFrame for each indicator</li>
<li>Handle missing values and filter to relevant years (1996, 2016, 2019)</li>
<li>Note: The API returns data for regions/aggregates as well as countries; you may want to filter these out</li>
<li>Merge the three indicators together by country and year</li>
</ul>
<p>See the World Bank API documentation for more details on available endpoints and filtering options.</p>
<p>For alcohol consumption: Use web scraping to extract the historical consumption table (with data for 1996, 2016, and 2019) from the Wikipedia page on alcohol consumption per capita.</p>
<p><strong>Before merging, prepare both datasets as follows:</strong></p>
<section id="a." class="level3">
<h3 class="anchored" data-anchor-id="a.">1a.</h3>
<p>World Bank API data: Parse the JSON responses from the World Bank API into DataFrames. The API response contains nested dictionaries with fields like country, date, and value. Extract the relevant fields into clean DataFrames for each indicator (life expectancy, population, and GDP per capita), then merge them together by country and year.</p>
</section>
<section id="b." class="level3">
<h3 class="anchored" data-anchor-id="b.">1b.</h3>
<p>Alcohol (scraped data): Identify which Wikipedia table contains the historical data (1996, 2016, 2019) and extract it. Clean the scraped data: remove any footnote markers (e.g., [1]), convert columns to appropriate data types, and handle any missing values.</p>
</section>
<section id="c." class="level3">
<h3 class="anchored" data-anchor-id="c.">1c.</h3>
<p>Reshape the alcohol data from wide to long format, creating a “Year” column with values 1996, 2016, and 2019. You can use pd.melt() in Python.</p>
</section>
<section id="d." class="level3">
<h3 class="anchored" data-anchor-id="d.">1d.</h3>
<p>Filter the life expectancy data to include only the years that match the alcohol data (1996, 2016, 2019).</p>
</section>
<section id="e." class="level3">
<h3 class="anchored" data-anchor-id="e.">1e.</h3>
<p>Merge these datasets by country name and year. Note: You may need to standardize country names between datasets (e.g., “United States” vs “United States of America”).</p>
</section>
<section id="f." class="level3">
<h3 class="anchored" data-anchor-id="f.">1f.</h3>
<p>Conduct basic EDA on the merged dataset: check dimensions, missing values, summary statistics of key variables to look for outliers. Which countries have the lowest and highest life expectancies and alcohol consumption?</p>
</section>
<section id="g." class="level3">
<h3 class="anchored" data-anchor-id="g.">1g.</h3>
<p>Write a paragraph describing your scraping and cleaning steps. Include a written summary of the variables and the number of observations before and after merging. Document any countries that didn’t match and how you handled them. Also summarize your findings from the basic EDA.</p>
</section>
</section>
<section id="points" class="level2">
<h2 class="anchored" data-anchor-id="points">2. (4 points)</h2>
<p>Create a summary table of the merged dataset showing the mean and sd of life expectancy, alcohol consumption, population, and GDP per capita by year. Briefly summarize.</p>
</section>
<section id="points-1" class="level2">
<h2 class="anchored" data-anchor-id="points-1">3. (4 points)</h2>
<p>Create a new categorical variable named “gdp_level” using the GDP per capita variable. Calculate the quartiles of GDP per capita. Categorize GDP level as low (0-q1), medium (q1-q3), and high (q3+). To make sure the variable is correctly coded, create a summary table that contains the minimum GDP per capita, maximum GDP per capita, and number of observations for each category.</p>
</section>
</section>
<section id="visualization" class="level1">
<h1>Visualization</h1>
<section id="points-2" class="level2">
<h2 class="anchored" data-anchor-id="points-2">4. (15 points)</h2>
<p>Create the following figures with plotnine and interpret them. Be sure to include easily understandable axes, titles, and legends.</p>
<section id="a.-1" class="level3">
<h3 class="anchored" data-anchor-id="a.-1">4a.</h3>
<p>Two line plots: one of life expectancy by year and the other of alcohol consumption by year with lines for Canada and 3 other contrasting countries.</p>
</section>
<section id="b.-1" class="level3">
<h3 class="anchored" data-anchor-id="b.-1">4b.</h3>
<p>Facet plot by year for 1996, 2016, and 2019 showing scatterplots with linear and lowess regression lines of life expectancy and alcohol consumption. regression lines of life expectancy and alcohol consumption.</p>
</section>
<section id="c.-1" class="level3">
<h3 class="anchored" data-anchor-id="c.-1">4c.</h3>
<p>Facet plot by year for 1996, 2016, and 2019 showing boxplots of alcohol consumption by GDP level.</p>
</section>
<section id="d.-1" class="level3">
<h3 class="anchored" data-anchor-id="d.-1">4d.</h3>
<p>A barplot showing life expectancy in 1996 and 2019 for the 10 countries with the largest change in life expectancy between 1996 and 2019. change in life expectancy between 1996 and 2019.</p>
</section>
<section id="e.-1" class="level3">
<h3 class="anchored" data-anchor-id="e.-1">4e.</h3>
<p>Come up with your own plot that will help to understand the role of GDP in the association between alcohol and life expectancy.</p>
</section>
</section>
</section>
<section id="advanced-regression" class="level1">
<h1>Advanced Regression</h1>
<section id="points-3" class="level2">
<h2 class="anchored" data-anchor-id="points-3">5. (8 points)</h2>
<p>Construct a multiple linear regression model to examine the association between life expectancy and alcohol consumption adjusted for GDP per capita, and year. Note you should scale GDP by population to get GDP per capita since the values can be very large. Then fit a gam model where you put a smooth on GDP per capita and alcohol consumption.Provide the following in your analyses:</p>
<section id="a.-2" class="level3">
<h3 class="anchored" data-anchor-id="a.-2">5a.</h3>
<p>Summaries of your models, including overall model fit and interpretation of the parameter estimates (linear and non-linear).</p>
</section>
<section id="b.-2" class="level3">
<h3 class="anchored" data-anchor-id="b.-2">5b.</h3>
<p>Plot of the smoothed variables from the gam model and interpret.</p>
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W119
</script>
<div id="exercise-loading-indicator" class="exercise-loading-indicator d-none d-flex align-items-center gap-2">
<div id="exercise-loading-status" class="d-flex gap-2">

</div>
<div class="spinner-grow spinner-grow-sm">

</div>
</div>
<script type="vfs-file">
W10=
</script>
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W119
</script>
<div id="exercise-loading-indicator" class="exercise-loading-indicator d-none d-flex align-items-center gap-2">
<div id="exercise-loading-status" class="d-flex gap-2">

</div>
<div class="spinner-grow spinner-grow-sm">

</div>
</div>
<script type="vfs-file">
W10=
</script>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W119
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../../..";
window._ojs.paths.runtimeToRoot = "../../../../..";
window._ojs.paths.docToRoot = "../..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>