<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yi Fan (Eric) Wang">
<meta name="dcterms.date" content="2026-02-14">

<title>Homework 2 — Data Scraping, APIs and Advanced Regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="hw2_files/libs/clipboard/clipboard.min.js"></script>
<script src="hw2_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="hw2_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="hw2_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="hw2_files/libs/quarto-html/popper.min.js"></script>
<script src="hw2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="hw2_files/libs/quarto-html/anchor.min.js"></script>
<link href="hw2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="hw2_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="hw2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="hw2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="hw2_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="hw2_files/libs/quarto-contrib/live-runtime/live-runtime.js" type="module"></script>
<link href="hw2_files/libs/quarto-contrib/live-runtime/live-runtime.css" rel="stylesheet">
<script type="module" src="hw2_files/libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="hw2_files/libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-goals" id="toc-learning-goals" class="nav-link active" data-scroll-target="#learning-goals">Learning Goals</a></li>
  <li><a href="#assignment-description" id="toc-assignment-description" class="nav-link" data-scroll-target="#assignment-description">Assignment Description</a></li>
  <li><a href="#environment-setup" id="toc-environment-setup" class="nav-link" data-scroll-target="#environment-setup">Environment Setup</a></li>
  <li><a href="#data-acquisition-and-wrangling" id="toc-data-acquisition-and-wrangling" class="nav-link" data-scroll-target="#data-acquisition-and-wrangling">Data Acquisition and Wrangling</a>
  <ul class="collapse">
  <li><a href="#points-obtain-two-datasets-life-expectancy-via-api-and-alcohol-consumption-via-web-scraping." id="toc-points-obtain-two-datasets-life-expectancy-via-api-and-alcohol-consumption-via-web-scraping." class="nav-link" data-scroll-target="#points-obtain-two-datasets-life-expectancy-via-api-and-alcohol-consumption-via-web-scraping.">1. (15 points) Obtain two datasets: life expectancy (via API) and alcohol consumption (via web scraping).</a>
  <ul class="collapse">
  <li><a href="#a." id="toc-a." class="nav-link" data-scroll-target="#a.">1a.</a></li>
  <li><a href="#b." id="toc-b." class="nav-link" data-scroll-target="#b.">1b.</a></li>
  <li><a href="#c." id="toc-c." class="nav-link" data-scroll-target="#c.">1c.</a></li>
  <li><a href="#d." id="toc-d." class="nav-link" data-scroll-target="#d.">1d.</a></li>
  <li><a href="#merge-these-datasets-by-country-name-and-year.-note-you-may-need-to-standardize-country-names-between-datasets-e.g.-united-states-vs-united-states-of-america." id="toc-merge-these-datasets-by-country-name-and-year.-note-you-may-need-to-standardize-country-names-between-datasets-e.g.-united-states-vs-united-states-of-america." class="nav-link" data-scroll-target="#merge-these-datasets-by-country-name-and-year.-note-you-may-need-to-standardize-country-names-between-datasets-e.g.-united-states-vs-united-states-of-america.">Merge these datasets by country name and year. Note: You may need to standardize country names between datasets (e.g., “United States” vs “United States of America”).</a></li>
  <li><a href="#conduct-basic-eda-on-the-merged-dataset-check-dimensions-missing-values-summary-statistics-of-key-variables-to-look-for-outliers.-which-countries-have-the-lowest-and-highest-life-expectancies-and-alcohol-consumption" id="toc-conduct-basic-eda-on-the-merged-dataset-check-dimensions-missing-values-summary-statistics-of-key-variables-to-look-for-outliers.-which-countries-have-the-lowest-and-highest-life-expectancies-and-alcohol-consumption" class="nav-link" data-scroll-target="#conduct-basic-eda-on-the-merged-dataset-check-dimensions-missing-values-summary-statistics-of-key-variables-to-look-for-outliers.-which-countries-have-the-lowest-and-highest-life-expectancies-and-alcohol-consumption">Conduct basic EDA on the merged dataset: check dimensions, missing values, summary statistics of key variables to look for outliers. Which countries have the lowest and highest life expectancies and alcohol consumption?</a></li>
  <li><a href="#write-a-paragraph-describing-your-scraping-and-cleaning-steps.-include-a-written-summary-of-the-variables-and-the-number-of-observations-before-and-after-merging.-document-any-countries-that-didnt-match-and-how-you-handled-them.-also-summarize-your-findings-from-the-basic-eda." id="toc-write-a-paragraph-describing-your-scraping-and-cleaning-steps.-include-a-written-summary-of-the-variables-and-the-number-of-observations-before-and-after-merging.-document-any-countries-that-didnt-match-and-how-you-handled-them.-also-summarize-your-findings-from-the-basic-eda." class="nav-link" data-scroll-target="#write-a-paragraph-describing-your-scraping-and-cleaning-steps.-include-a-written-summary-of-the-variables-and-the-number-of-observations-before-and-after-merging.-document-any-countries-that-didnt-match-and-how-you-handled-them.-also-summarize-your-findings-from-the-basic-eda.">Write a paragraph describing your scraping and cleaning steps. Include a written summary of the variables and the number of observations before and after merging. Document any countries that didn’t match and how you handled them. Also summarize your findings from the basic EDA.</a></li>
  </ul></li>
  <li><a href="#points-create-a-summary-table-of-the-merged-dataset-showing-the-mean-and-sd-of-life-expectancy-alcohol-consumption-population-and-gdp-per-capita-by-year.-briefly-summarize." id="toc-points-create-a-summary-table-of-the-merged-dataset-showing-the-mean-and-sd-of-life-expectancy-alcohol-consumption-population-and-gdp-per-capita-by-year.-briefly-summarize." class="nav-link" data-scroll-target="#points-create-a-summary-table-of-the-merged-dataset-showing-the-mean-and-sd-of-life-expectancy-alcohol-consumption-population-and-gdp-per-capita-by-year.-briefly-summarize.">2. (4 points) Create a summary table of the merged dataset showing the mean and sd of life expectancy, alcohol consumption, population, and GDP per capita by year. Briefly summarize.</a></li>
  <li><a href="#points-create-a-new-categorical-variable-named-gdp_level-using-the-gdp-per-capita-variable.-calculate-the-quartiles-of-gdp-per-capita.-categorize-gdp-level-as-low-0-q1-medium-q1-q3-and-high-q3.-to-make-sure-the-variable-is-correctly-coded-create-a-summary-table-that-contains-the-minimum-gdp-per-capita-maximum-gdp-per-capita-and-number-of-observations-for-each-category." id="toc-points-create-a-new-categorical-variable-named-gdp_level-using-the-gdp-per-capita-variable.-calculate-the-quartiles-of-gdp-per-capita.-categorize-gdp-level-as-low-0-q1-medium-q1-q3-and-high-q3.-to-make-sure-the-variable-is-correctly-coded-create-a-summary-table-that-contains-the-minimum-gdp-per-capita-maximum-gdp-per-capita-and-number-of-observations-for-each-category." class="nav-link" data-scroll-target="#points-create-a-new-categorical-variable-named-gdp_level-using-the-gdp-per-capita-variable.-calculate-the-quartiles-of-gdp-per-capita.-categorize-gdp-level-as-low-0-q1-medium-q1-q3-and-high-q3.-to-make-sure-the-variable-is-correctly-coded-create-a-summary-table-that-contains-the-minimum-gdp-per-capita-maximum-gdp-per-capita-and-number-of-observations-for-each-category.">3. (4 points) Create a new categorical variable named “gdp_level” using the GDP per capita variable. Calculate the quartiles of GDP per capita. Categorize GDP level as low (0-q1), medium (q1-q3), and high (q3+). To make sure the variable is correctly coded, create a summary table that contains the minimum GDP per capita, maximum GDP per capita, and number of observations for each category.</a></li>
  </ul></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization">Visualization</a>
  <ul class="collapse">
  <li><a href="#points-create-the-following-figures-with-plotnine-and-interpret-them.-be-sure-to-include-easily-understandable-axes-titles-and-legends." id="toc-points-create-the-following-figures-with-plotnine-and-interpret-them.-be-sure-to-include-easily-understandable-axes-titles-and-legends." class="nav-link" data-scroll-target="#points-create-the-following-figures-with-plotnine-and-interpret-them.-be-sure-to-include-easily-understandable-axes-titles-and-legends.">4. (15 points) Create the following figures with plotnine and interpret them. Be sure to include easily understandable axes, titles, and legends.</a>
  <ul class="collapse">
  <li><a href="#a.-1" id="toc-a.-1" class="nav-link" data-scroll-target="#a.-1">4a.</a></li>
  <li><a href="#b.-1" id="toc-b.-1" class="nav-link" data-scroll-target="#b.-1">4b.</a></li>
  <li><a href="#c.-1" id="toc-c.-1" class="nav-link" data-scroll-target="#c.-1">4c.</a></li>
  <li><a href="#d.-1" id="toc-d.-1" class="nav-link" data-scroll-target="#d.-1">4d.</a></li>
  <li><a href="#e." id="toc-e." class="nav-link" data-scroll-target="#e.">4e.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#advanced-regression" id="toc-advanced-regression" class="nav-link" data-scroll-target="#advanced-regression">Advanced Regression</a>
  <ul class="collapse">
  <li><a href="#points-construct-a-multiple-linear-regression-model-to-examine-the-association-between-life-expectancy-and-alcohol-consumption-adjusted-for-gdp-per-capita-and-year.-note-you-should-scale-gdp-by-population-to-get-gdp-per-capita-since-the-values-can-be-very-large.-then-fit-a-gam-model-where-you-put-a-smooth-on-gdp-per-capita-and-alcohol-consumption.provide-the-following-in-your-analyses" id="toc-points-construct-a-multiple-linear-regression-model-to-examine-the-association-between-life-expectancy-and-alcohol-consumption-adjusted-for-gdp-per-capita-and-year.-note-you-should-scale-gdp-by-population-to-get-gdp-per-capita-since-the-values-can-be-very-large.-then-fit-a-gam-model-where-you-put-a-smooth-on-gdp-per-capita-and-alcohol-consumption.provide-the-following-in-your-analyses" class="nav-link" data-scroll-target="#points-construct-a-multiple-linear-regression-model-to-examine-the-association-between-life-expectancy-and-alcohol-consumption-adjusted-for-gdp-per-capita-and-year.-note-you-should-scale-gdp-by-population-to-get-gdp-per-capita-since-the-values-can-be-very-large.-then-fit-a-gam-model-where-you-put-a-smooth-on-gdp-per-capita-and-alcohol-consumption.provide-the-following-in-your-analyses">5. (8 points) Construct a multiple linear regression model to examine the association between life expectancy and alcohol consumption adjusted for GDP per capita, and year. Note you should scale GDP by population to get GDP per capita since the values can be very large. Then fit a gam model where you put a smooth on GDP per capita and alcohol consumption.Provide the following in your analyses:</a>
  <ul class="collapse">
  <li><a href="#a.-2" id="toc-a.-2" class="nav-link" data-scroll-target="#a.-2">5a.</a></li>
  <li><a href="#b.-2" id="toc-b.-2" class="nav-link" data-scroll-target="#b.-2">5b.</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Homework 2 — Data Scraping, APIs and Advanced Regression</h1>
<p class="subtitle lead">JSC370 (Winter 2026)</p>
</div>



<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Yi Fan (Eric) Wang </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 14, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="learning-goals" class="level1">
<h1>Learning Goals</h1>
<ul>
<li>Use an API, scrape, wrangle, and get familiar different datasets.</li>
<li>Make visualizations</li>
<li>Conduct GAM regression modeling and compare to linear regression</li>
</ul>
</section>
<section id="assignment-description" class="level1">
<h1>Assignment Description</h1>
<p>For this assignment, we will be analyzing data on life expectancy and alcohol consumption. The learning objectives are to conduct data wrangling and visualization keeping key questions in mind. We will also do a regression analysis.</p>
<p>The primary questions of interest are:</p>
<ul>
<li>Is there an association between life expectancy and alcohol consumption?</li>
<li>How have life expectancy and alcohol consumption changed over time?</li>
<li>Do other country specific factors such as per capita gross domestic product or population play a role in the relationship between alcohol consumption and life expectancy?</li>
</ul>
</section>
<section id="environment-setup" class="level1">
<h1>Environment Setup</h1>
<div id="environment-setup" class="cell" data-message="false" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> StringIO</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="data-acquisition-and-wrangling" class="level1">
<h1>Data Acquisition and Wrangling</h1>
<section id="points-obtain-two-datasets-life-expectancy-via-api-and-alcohol-consumption-via-web-scraping." class="level2">
<h2 class="anchored" data-anchor-id="points-obtain-two-datasets-life-expectancy-via-api-and-alcohol-consumption-via-web-scraping.">1. (15 points) Obtain two datasets: life expectancy (via API) and alcohol consumption (via web scraping).</h2>
<p>For life expectancy, population, and GDP: Use the World Bank API to fetch the following indicators:</p>
<ul>
<li>SP.DYN.LE00.IN - Life expectancy at birth, total (years)</li>
<li>SP.POP.TOTL - Population, total</li>
<li>NY.GDP.PCAP.CD - GDP per capita (current US$)</li>
</ul>
<p>You will need to:</p>
<ul>
<li>Parse the nested JSON response into a clean DataFrame for each indicator</li>
<li>Handle missing values and filter to relevant years (1996, 2016, 2019)</li>
<li>Note: The API returns data for regions/aggregates as well as countries; you may want to filter these out</li>
<li>Merge the three indicators together by country and year</li>
</ul>
<p>See the World Bank API documentation for more details on available endpoints and filtering options.</p>
<p>For alcohol consumption: Use web scraping to extract the historical consumption table (with data for 1996, 2016, and 2019) from the Wikipedia page on alcohol consumption per capita.</p>
<p><strong>Before merging, prepare both datasets as follows:</strong></p>
<section id="a." class="level3">
<h3 class="anchored" data-anchor-id="a.">1a.</h3>
<p>World Bank API data: Parse the JSON responses from the World Bank API into DataFrames. The API response contains nested dictionaries with fields like country, date, and value. Extract the relevant fields into clean DataFrames for each indicator (life expectancy, population, and GDP per capita), then merge them together by country and year.</p>
<div id="a-world-bank-api-data" class="cell" data-message="false" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>BASE_URL <span class="op">=</span> <span class="st">"https://api.worldbank.org/v2/country/all/indicator"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>COUNTRY_META_URL <span class="op">=</span> <span class="st">"https://api.worldbank.org/v2/country"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>INDICATORS <span class="op">=</span> {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"life_expectancy"</span>: <span class="st">"SP.DYN.LE00.IN"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"population"</span>: <span class="st">"SP.POP.TOTL"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gdp_per_capita"</span>: <span class="st">"NY.GDP.PCAP.CD"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_world_bank_pages(indicator_code):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Fetch all pages for one World Bank indicator.</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a list of raw records from the JSON response.</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    indicator_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>BASE_URL<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>indicator_code<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    page <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    all_records <span class="op">=</span> []</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        params <span class="op">=</span> {</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"format"</span>: <span class="st">"json"</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"per_page"</span>: <span class="dv">20000</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"page"</span>: page,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.get(indicator_url, params<span class="op">=</span>params, timeout<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        response.raise_for_status()</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        payload <span class="op">=</span> response.json()</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># JSON structure: payload[0] = metadata, payload[1] = records</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> payload[<span class="dv">0</span>]</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        records <span class="op">=</span> payload[<span class="dv">1</span>]</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        all_records.extend(records)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> page <span class="op">&gt;=</span> <span class="bu">int</span>(metadata[<span class="st">"pages"</span>]):</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        page <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> all_records</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_country_metadata():</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="co">    Fetch country metadata.</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    page <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    all_countries <span class="op">=</span> []</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        params <span class="op">=</span> {</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">"format"</span>: <span class="st">"json"</span>,</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">"per_page"</span>: <span class="dv">400</span>,</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">"page"</span>: page,</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.get(COUNTRY_META_URL, params<span class="op">=</span>params, timeout<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>        response.raise_for_status()</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        payload <span class="op">=</span> response.json()</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> payload[<span class="dv">0</span>]</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>        rows <span class="op">=</span> payload[<span class="dv">1</span>]</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>        all_countries.extend(rows)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> page <span class="op">&gt;=</span> <span class="bu">int</span>(metadata[<span class="st">"pages"</span>]):</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>        page <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    countries_df <span class="op">=</span> pd.DataFrame(all_countries)</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    countries_df[<span class="st">"region_name"</span>] <span class="op">=</span> countries_df[<span class="st">"region"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">"value"</span>) <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">dict</span>) <span class="cf">else</span> np.nan)</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> countries_df</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_indicator_records(records, value_name):</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse nested JSON fields and keep relevant columns.</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(records)</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract nested values from API response</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"country"</span>] <span class="op">=</span> df[<span class="st">"country"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.get(<span class="st">"value"</span>) <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">dict</span>) <span class="cf">else</span> np.nan)</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"year"</span>] <span class="op">=</span> pd.to_numeric(df[<span class="st">"date"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    df[value_name] <span class="op">=</span> pd.to_numeric(df[<span class="st">"value"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[[<span class="st">"countryiso3code"</span>, <span class="st">"country"</span>, <span class="st">"year"</span>, value_name]].copy()</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Fetch and parse indicator data</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>life_records <span class="op">=</span> get_world_bank_pages(INDICATORS[<span class="st">"life_expectancy"</span>])</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>pop_records <span class="op">=</span> get_world_bank_pages(INDICATORS[<span class="st">"population"</span>])</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>gdp_records <span class="op">=</span> get_world_bank_pages(INDICATORS[<span class="st">"gdp_per_capita"</span>])</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>life_expectancy_raw <span class="op">=</span> parse_indicator_records(life_records, <span class="st">"life_expectancy"</span>)</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>population_raw <span class="op">=</span> parse_indicator_records(pop_records, <span class="st">"population"</span>)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>gdp_per_capita_raw <span class="op">=</span> parse_indicator_records(gdp_records, <span class="st">"gdp_per_capita"</span>)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Build official non-aggregate country list from metadata</span></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>countries_df <span class="op">=</span> get_country_metadata()</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>valid_iso3 <span class="op">=</span> <span class="bu">set</span>(countries_df.loc[countries_df[<span class="st">"region_name"</span>] <span class="op">!=</span> <span class="st">"Aggregates"</span>, <span class="st">"id"</span>].dropna())</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Aggregate Checks before removing aggregates</span></span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows before removing aggregates:"</span>)</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"life_expectancy_raw:"</span>, <span class="bu">len</span>(life_expectancy_raw))</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"population_raw:"</span>, <span class="bu">len</span>(population_raw))</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"gdp_per_capita_raw:"</span>, <span class="bu">len</span>(gdp_per_capita_raw))</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>life_aggregate_rows <span class="op">=</span> life_expectancy_raw[<span class="op">~</span>life_expectancy_raw[<span class="st">"countryiso3code"</span>].isin(valid_iso3)].copy()</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>life_aggregate_pairs <span class="op">=</span> life_aggregate_rows[[<span class="st">"countryiso3code"</span>, <span class="st">"country"</span>]].drop_duplicates()</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Unique (countryiso3code, country) aggregate pairs in life data:"</span>, life_aggregate_pairs.shape[<span class="dv">0</span>])</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Aggregate rows before filtering (all years/values) in life data:"</span>, life_aggregate_rows.shape[<span class="dv">0</span>])</span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>display(life_aggregate_pairs.head(<span class="dv">10</span>))</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>all_raw <span class="op">=</span> pd.concat(</span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>        life_expectancy_raw[[<span class="st">"countryiso3code"</span>, <span class="st">"country"</span>]],</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>        population_raw[[<span class="st">"countryiso3code"</span>, <span class="st">"country"</span>]],</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>        gdp_per_capita_raw[[<span class="st">"countryiso3code"</span>, <span class="st">"country"</span>]],</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>    ignore_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>).drop_duplicates()</span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>all_aggregate_names_in_original_data <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>    all_raw.loc[<span class="op">~</span>all_raw[<span class="st">"countryiso3code"</span>].isin(valid_iso3), <span class="st">"country"</span>].dropna().unique()</span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"All aggregate/group names in original fetched data:"</span>, <span class="bu">len</span>(all_aggregate_names_in_original_data))</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>display(pd.DataFrame({<span class="st">"aggregate_name_in_original_data"</span>: all_aggregate_names_in_original_data}))</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Remove aggregates</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>life_expectancy_raw <span class="op">=</span> life_expectancy_raw[life_expectancy_raw[<span class="st">"countryiso3code"</span>].isin(valid_iso3)].copy()</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>population_raw <span class="op">=</span> population_raw[population_raw[<span class="st">"countryiso3code"</span>].isin(valid_iso3)].copy()</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>gdp_per_capita_raw <span class="op">=</span> gdp_per_capita_raw[gdp_per_capita_raw[<span class="st">"countryiso3code"</span>].isin(valid_iso3)].copy()</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows after removing aggregates:"</span>)</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"life_expectancy_raw:"</span>, <span class="bu">len</span>(life_expectancy_raw))</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"population_raw:"</span>, <span class="bu">len</span>(population_raw))</span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"gdp_per_capita_raw:"</span>, <span class="bu">len</span>(gdp_per_capita_raw))</span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sample rows after removing aggregates:"</span>)</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"life_expectancy_raw:"</span>)</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>display(life_expectancy_raw.head())</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"population_raw:"</span>)</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>display(population_raw.head())</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"gdp_per_capita_raw:"</span>)</span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>display(gdp_per_capita_raw.head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows before removing aggregates:
life_expectancy_raw: 17290
population_raw: 17290
gdp_per_capita_raw: 17290
Unique (countryiso3code, country) aggregate pairs in life data: 49
Aggregate rows before filtering (all years/values) in life data: 3185</code></pre>
</div>
<div id="a-world-bank-api-data-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">countryiso3code</th>
<th data-quarto-table-cell-role="th">country</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>AFE</td>
<td>Africa Eastern and Southern</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">65</th>
<td>AFW</td>
<td>Africa Western and Central</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">130</th>
<td>ARB</td>
<td>Arab World</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">195</th>
<td>CSS</td>
<td>Caribbean small states</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">260</th>
<td>CEB</td>
<td>Central Europe and the Baltics</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">325</th>
<td>EAR</td>
<td>Early-demographic dividend</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">390</th>
<td>EAS</td>
<td>East Asia &amp; Pacific</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">455</th>
<td>EAP</td>
<td>East Asia &amp; Pacific (excluding high income)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">520</th>
<td>TEA</td>
<td>East Asia &amp; Pacific (IDA &amp; IBRD countries)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">585</th>
<td>EMU</td>
<td>Euro area</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>All aggregate/group names in original fetched data: 49</code></pre>
</div>
<div id="a-world-bank-api-data-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">aggregate_name_in_original_data</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Africa Eastern and Southern</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Africa Western and Central</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Arab World</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Caribbean small states</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Central Europe and the Baltics</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Early-demographic dividend</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>East Asia &amp; Pacific</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>East Asia &amp; Pacific (IDA &amp; IBRD countries)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>East Asia &amp; Pacific (excluding high income)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Euro area</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>Europe &amp; Central Asia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>Europe &amp; Central Asia (IDA &amp; IBRD countries)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>Europe &amp; Central Asia (excluding high income)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>European Union</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>Fragile and conflict affected situations</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>Heavily indebted poor countries (HIPC)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>High income</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>IBRD only</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>IDA &amp; IBRD total</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td>IDA blend</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>IDA only</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>IDA total</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">22</th>
<td>Late-demographic dividend</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td>Latin America &amp; Caribbean</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>Latin America &amp; Caribbean (excluding high income)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25</th>
<td>Latin America &amp; the Caribbean (IDA &amp; IBRD coun...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">26</th>
<td>Least developed countries: UN classification</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>Low &amp; middle income</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">28</th>
<td>Low income</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">29</th>
<td>Lower middle income</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">30</th>
<td>Middle East, North Africa, Afghanistan &amp; Pakistan</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">31</th>
<td>Middle East, North Africa, Afghanistan &amp; Pakis...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">32</th>
<td>Middle East, North Africa, Afghanistan &amp; Pakis...</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">33</th>
<td>Middle income</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">34</th>
<td>North America</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">35</th>
<td>Not classified</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">36</th>
<td>OECD members</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">37</th>
<td>Other small states</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">38</th>
<td>Pacific island small states</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">39</th>
<td>Post-demographic dividend</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">40</th>
<td>Pre-demographic dividend</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">41</th>
<td>Small states</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">42</th>
<td>South Asia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">43</th>
<td>South Asia (IDA &amp; IBRD)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">44</th>
<td>Sub-Saharan Africa</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">45</th>
<td>Sub-Saharan Africa (IDA &amp; IBRD countries)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">46</th>
<td>Sub-Saharan Africa (excluding high income)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">47</th>
<td>Upper middle income</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">48</th>
<td>World</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows after removing aggregates:
life_expectancy_raw: 14105
population_raw: 14105
gdp_per_capita_raw: 14105
Sample rows after removing aggregates:
life_expectancy_raw:</code></pre>
</div>
<div id="a-world-bank-api-data-3" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">countryiso3code</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">life_expectancy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">3185</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2024</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3186</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2023</td>
<td>66.035</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3187</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2022</td>
<td>65.617</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3188</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2021</td>
<td>60.417</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3189</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2020</td>
<td>61.454</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>population_raw:</code></pre>
</div>
<div id="a-world-bank-api-data-4" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">countryiso3code</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">population</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">3185</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2024</td>
<td>42647492.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3186</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2023</td>
<td>41454761.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3187</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2022</td>
<td>40578842.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3188</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2021</td>
<td>40000412.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3189</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2020</td>
<td>39068979.0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>gdp_per_capita_raw:</code></pre>
</div>
<div id="a-world-bank-api-data-5" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">countryiso3code</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">gdp_per_capita</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">3185</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2024</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3186</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2023</td>
<td>413.757895</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3187</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2022</td>
<td>357.261153</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3188</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2021</td>
<td>356.496214</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3189</th>
<td>AFG</td>
<td>Afghanistan</td>
<td>2020</td>
<td>510.787063</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="a-world-bank-data-handling-missing-values" class="cell" data-message="false" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># keep only country/year/indicator columns before missing-value handling</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>life_expectancy_raw <span class="op">=</span> life_expectancy_raw[[<span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"life_expectancy"</span>]].copy()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>population_raw <span class="op">=</span> population_raw[[<span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"population"</span>]].copy()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>gdp_per_capita_raw <span class="op">=</span> gdp_per_capita_raw[[<span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"gdp_per_capita"</span>]].copy()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check missing values</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Missing values before handling:"</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"life_expectancy_raw:"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(life_expectancy_raw[[<span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"life_expectancy"</span>]].isna().<span class="bu">sum</span>())</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"population_raw:"</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(population_raw[[<span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"population"</span>]].isna().<span class="bu">sum</span>())</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"gdp_per_capita_raw:"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gdp_per_capita_raw[[<span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"gdp_per_capita"</span>]].isna().<span class="bu">sum</span>())</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows with missing key fields / indicator values</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>life_expectancy_df <span class="op">=</span> life_expectancy_raw.dropna(</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"life_expectancy"</span>]</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>).copy()</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>population_df <span class="op">=</span> population_raw.dropna(</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"population"</span>]</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>).copy()</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>gdp_per_capita_df <span class="op">=</span> gdp_per_capita_raw.dropna(</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"gdp_per_capita"</span>]</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>).copy()</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep year as integer after dropping missing values</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>life_expectancy_df[<span class="st">"year"</span>] <span class="op">=</span> life_expectancy_df[<span class="st">"year"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>population_df[<span class="st">"year"</span>] <span class="op">=</span> population_df[<span class="st">"year"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>gdp_per_capita_df[<span class="st">"year"</span>] <span class="op">=</span> gdp_per_capita_df[<span class="st">"year"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows after missing-value handling:"</span>)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"life_expectancy_df:"</span>, life_expectancy_df.shape)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"population_df:"</span>, population_df.shape)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"gdp_per_capita_df:"</span>, gdp_per_capita_df.shape)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Missing values before handling:
life_expectancy_raw:
country              0
year                 0
life_expectancy    251
dtype: int64
population_raw:
country        0
year           0
population    30
dtype: int64
gdp_per_capita_raw:
country              0
year                 0
gdp_per_capita    2536
dtype: int64
Rows after missing-value handling:
life_expectancy_df: (13854, 3)
population_df: (14075, 3)
gdp_per_capita_df: (11569, 3)</code></pre>
</div>
</div>
<div id="cell-1a-World-Bank-Data-Merge" class="cell" data-message="false" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Merge life expectancy with population</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>world_bank_df <span class="op">=</span> life_expectancy_df.merge(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    population_df,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"outer"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"country"</span>, <span class="st">"year"</span>],</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Merge in GDP per capita</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>world_bank_df <span class="op">=</span> world_bank_df.merge(</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    gdp_per_capita_df,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"outer"</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"country"</span>, <span class="st">"year"</span>],</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Sort for readability</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>world_bank_df <span class="op">=</span> world_bank_df.sort_values([<span class="st">"country"</span>, <span class="st">"year"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Merge summary (Lab 5 style)</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"life_expectancy_df rows: </span><span class="sc">{</span><span class="bu">len</span>(life_expectancy_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"population_df rows: </span><span class="sc">{</span><span class="bu">len</span>(population_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"gdp_per_capita_df rows: </span><span class="sc">{</span><span class="bu">len</span>(gdp_per_capita_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Merged world_bank_df shape: </span><span class="sc">{</span>world_bank_df<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>display(world_bank_df.head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>life_expectancy_df rows: 13854
population_df rows: 14075
gdp_per_capita_df rows: 11569
Merged world_bank_df shape: (14075, 5)</code></pre>
</div>
<div id="a-world-bank-data-merge" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">life_expectancy</th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">gdp_per_capita</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Afghanistan</td>
<td>1960</td>
<td>32.799</td>
<td>9035043.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Afghanistan</td>
<td>1961</td>
<td>33.291</td>
<td>9214083.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Afghanistan</td>
<td>1962</td>
<td>33.757</td>
<td>9404406.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Afghanistan</td>
<td>1963</td>
<td>34.201</td>
<td>9604487.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Afghanistan</td>
<td>1964</td>
<td>34.673</td>
<td>9814318.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Afghanistan</td>
<td>1965</td>
<td>35.124</td>
<td>10036008.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Afghanistan</td>
<td>1966</td>
<td>35.583</td>
<td>10266395.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Afghanistan</td>
<td>1967</td>
<td>36.042</td>
<td>10505959.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Afghanistan</td>
<td>1968</td>
<td>36.510</td>
<td>10756922.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Afghanistan</td>
<td>1969</td>
<td>36.979</td>
<td>11017409.0</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="b." class="level3">
<h3 class="anchored" data-anchor-id="b.">1b.</h3>
<p>Alcohol (scraped data): Identify which Wikipedia table contains the historical data (1996, 2016, 2019) and extract it. Clean the scraped data: remove any footnote markers (e.g., [1]), convert columns to appropriate data types, and handle any missing values.</p>
<div id="cell-1b-Alcohol-Data-Web-Scraping" class="cell" data-message="false" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ALCOHOL_WIKI_URL <span class="op">=</span> <span class="st">"https://en.wikipedia.org/wiki/List_of_countries_by_alcohol_consumption_per_capita"</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>HEADERS <span class="op">=</span> {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"User-Agent"</span>: <span class="st">"jsc370-class-project/1.0 (educational use)"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Accept-Language"</span>: <span class="st">"en-US,en;q=0.9"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch the page</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>alcohol_request <span class="op">=</span> requests.get(ALCOHOL_WIKI_URL, headers<span class="op">=</span>HEADERS, timeout<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Status code: </span><span class="sc">{</span>alcohol_request<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Parse all tables</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>alcohol_tables <span class="op">=</span> pd.read_html(StringIO(alcohol_request.text))</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span><span class="bu">len</span>(alcohol_tables)<span class="sc">}</span><span class="ss"> tables"</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># historical table is table index 1 after checking the wikipedia page</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>alcohol_raw <span class="op">=</span> alcohol_tables[<span class="dv">1</span>].copy()</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Selected table index: 1"</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"alcohol_raw shape: </span><span class="sc">{</span>alcohol_raw<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>display(alcohol_raw.head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Status code: 200
Found 15 tables

Selected table index: 1
alcohol_raw shape: (191, 4)</code></pre>
</div>
<div id="b-alcohol-data-web-scraping" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Country</th>
<th data-quarto-table-cell-role="th">1996[9]</th>
<th data-quarto-table-cell-role="th">2016[10]</th>
<th data-quarto-table-cell-role="th">2019[6][a]</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Afghanistan</td>
<td>–</td>
<td>0.2</td>
<td>0.2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Albania</td>
<td>2.59</td>
<td>7.5</td>
<td>5.1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Algeria</td>
<td>0.27</td>
<td>0.9</td>
<td>0.6</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Andorra</td>
<td>–</td>
<td>11.3</td>
<td>11.1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Angola</td>
<td>1.58</td>
<td>6.4</td>
<td>6.2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Antigua and Barbuda</td>
<td>–</td>
<td>7.0</td>
<td>8.5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Argentina</td>
<td>9.58</td>
<td>9.8</td>
<td>8.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Armenia</td>
<td>0.84</td>
<td>5.5</td>
<td>5.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Australia</td>
<td>9.55</td>
<td>10.6</td>
<td>10.1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Austria</td>
<td>11.90</td>
<td>11.6</td>
<td>12.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-1b-Alcohol-Data-Footnotes-Removal-and-Adjust-Data-Types" class="cell" data-message="false" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start from extracted table</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>alcohol_df <span class="op">=</span> alcohol_raw.copy()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 5 style for column names: string -&gt; extract target text</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>col_series <span class="op">=</span> pd.Series(alcohol_df.columns.astype(<span class="bu">str</span>))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>clean_year_cols <span class="op">=</span> col_series.<span class="bu">str</span>.extract(<span class="vs">r"</span><span class="kw">(</span><span class="dv">\d</span><span class="op">{4}</span><span class="kw">)</span><span class="vs">"</span>)[<span class="dv">0</span>]</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>alcohol_df.columns <span class="op">=</span> np.where(col_series.<span class="bu">str</span>.contains(<span class="st">"Country"</span>), <span class="st">"Country"</span>, clean_year_cols)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only needed columns after column-name cleaning</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>alcohol_df <span class="op">=</span> alcohol_df[[<span class="st">"Country"</span>, <span class="st">"1996"</span>, <span class="st">"2016"</span>, <span class="st">"2019"</span>]].copy()</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove footnote markers from country names</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>alcohol_df[<span class="st">"Country"</span>] <span class="op">=</span> (</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    alcohol_df[<span class="st">"Country"</span>].astype(<span class="bu">str</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="vs">r"</span><span class="ch">\[</span><span class="dv">\d</span><span class="op">+</span><span class="ch">\]</span><span class="vs">"</span>, <span class="st">""</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.replace(<span class="vs">r"</span><span class="ch">\[</span><span class="pp">[a-zA-Z]</span><span class="op">+</span><span class="ch">\]</span><span class="vs">"</span>, <span class="st">""</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">str</span>.strip()</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Lab 5 logic: string -&gt; extract first numeric -&gt; numeric</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"1996"</span>, <span class="st">"2016"</span>, <span class="st">"2019"</span>]:</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    alcohol_df[col] <span class="op">=</span> alcohol_df[col].astype(<span class="bu">str</span>).<span class="bu">str</span>.extract(<span class="vs">r"</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span>(?:<span class="ch">\.</span><span class="dv">\d</span><span class="op">+</span>)<span class="op">?</span><span class="kw">)</span><span class="vs">"</span>)[<span class="dv">0</span>]</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    alcohol_df[col] <span class="op">=</span> pd.to_numeric(alcohol_df[col], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"After footnote-marker removal:"</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(alcohol_df.dtypes)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>display(alcohol_df.head(<span class="dv">10</span>))</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(alcohol_df.shape)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>After footnote-marker removal:
Country     object
1996       float64
2016       float64
2019       float64
dtype: object</code></pre>
</div>
<div id="b-alcohol-data-footnotes-removal-and-adjust-data-types" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Country</th>
<th data-quarto-table-cell-role="th">1996</th>
<th data-quarto-table-cell-role="th">2016</th>
<th data-quarto-table-cell-role="th">2019</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Afghanistan</td>
<td>NaN</td>
<td>0.2</td>
<td>0.2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Albania</td>
<td>2.59</td>
<td>7.5</td>
<td>5.1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Algeria</td>
<td>0.27</td>
<td>0.9</td>
<td>0.6</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Andorra</td>
<td>NaN</td>
<td>11.3</td>
<td>11.1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Angola</td>
<td>1.58</td>
<td>6.4</td>
<td>6.2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Antigua and Barbuda</td>
<td>NaN</td>
<td>7.0</td>
<td>8.5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Argentina</td>
<td>9.58</td>
<td>9.8</td>
<td>8.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Armenia</td>
<td>0.84</td>
<td>5.5</td>
<td>5.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Australia</td>
<td>9.55</td>
<td>10.6</td>
<td>10.1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Austria</td>
<td>11.90</td>
<td>11.6</td>
<td>12.0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>(191, 4)</code></pre>
</div>
</div>
<div id="cell-1b-Alcohol-Data-Inspect-Missing-Values" class="cell" data-message="false" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect missingness first (before any dropping/imputation)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Missing values in alcohol_df:"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(alcohol_df[[<span class="st">"Country"</span>, <span class="st">"1996"</span>, <span class="st">"2016"</span>, <span class="st">"2019"</span>]].isna().<span class="bu">sum</span>())</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Rows with at least one missing alcohol value:"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>alcohol_missing_rows <span class="op">=</span> alcohol_df[alcohol_df[[<span class="st">"1996"</span>, <span class="st">"2016"</span>, <span class="st">"2019"</span>]].isna().<span class="bu">any</span>(axis<span class="op">=</span><span class="dv">1</span>)].copy()</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(alcohol_missing_rows.shape)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>display(alcohol_missing_rows.head(<span class="dv">10</span>))</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Percent missing by alcohol year column:"</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>((alcohol_df[[<span class="st">"1996"</span>, <span class="st">"2016"</span>, <span class="st">"2019"</span>]].isna().mean() <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Missing values in alcohol_df:
Country     0
1996       43
2016        2
2019        2
dtype: int64

Rows with at least one missing alcohol value:
(45, 4)</code></pre>
</div>
<div id="b-alcohol-data-inspect-missing-values" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Country</th>
<th data-quarto-table-cell-role="th">1996</th>
<th data-quarto-table-cell-role="th">2016</th>
<th data-quarto-table-cell-role="th">2019</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Afghanistan</td>
<td>NaN</td>
<td>0.2</td>
<td>0.2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Andorra</td>
<td>NaN</td>
<td>11.3</td>
<td>11.1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">5</th>
<td>Antigua and Barbuda</td>
<td>NaN</td>
<td>7.0</td>
<td>8.5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>Bahamas</td>
<td>NaN</td>
<td>4.4</td>
<td>4.4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>Bahrain</td>
<td>NaN</td>
<td>1.9</td>
<td>1.6</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>Bangladesh</td>
<td>NaN</td>
<td>0.0</td>
<td>0.1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">15</th>
<td>Bhutan</td>
<td>NaN</td>
<td>0.6</td>
<td>0.2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">37</th>
<td>Comoros</td>
<td>NaN</td>
<td>0.9</td>
<td>0.3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">39</th>
<td>Cook Islands</td>
<td>NaN</td>
<td>10.6</td>
<td>10.6</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">48</th>
<td>Dominica</td>
<td>NaN</td>
<td>8.2</td>
<td>6.1</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Percent missing by alcohol year column:
1996    22.51
2016     1.05
2019     1.05
dtype: float64</code></pre>
</div>
</div>
</section>
<section id="c." class="level3">
<h3 class="anchored" data-anchor-id="c.">1c.</h3>
<p>Reshape the alcohol data from wide to long format, creating a “Year” column with values 1996, 2016, and 2019. You can use pd.melt() in Python.</p>
<div id="cell-1c-Alcohol-Data-Reshape" class="cell" data-message="false" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>alcohol_long <span class="op">=</span> alcohol_df.melt(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    id_vars<span class="op">=</span><span class="st">"Country"</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    value_vars<span class="op">=</span>[<span class="st">"1996"</span>, <span class="st">"2016"</span>, <span class="st">"2019"</span>],</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    var_name<span class="op">=</span><span class="st">"Year"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    value_name<span class="op">=</span><span class="st">"alcohol_litres_per_capita_15plus"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep year as integer after reshaping</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>alcohol_long[<span class="st">"Year"</span>] <span class="op">=</span> pd.to_numeric(alcohol_long[<span class="st">"Year"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>).astype(<span class="bu">int</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort for readability before preview</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>alcohol_long <span class="op">=</span> alcohol_long.sort_values([<span class="st">"Country"</span>, <span class="st">"Year"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"alcohol_long shape:"</span>, alcohol_long.shape)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>display(alcohol_long.head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>alcohol_long shape: (573, 3)</code></pre>
</div>
<div id="c-alcohol-data-reshape" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Country</th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">alcohol_litres_per_capita_15plus</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Afghanistan</td>
<td>1996</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Afghanistan</td>
<td>2016</td>
<td>0.20</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Afghanistan</td>
<td>2019</td>
<td>0.20</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Albania</td>
<td>1996</td>
<td>2.59</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Albania</td>
<td>2016</td>
<td>7.50</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Albania</td>
<td>2019</td>
<td>5.10</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Algeria</td>
<td>1996</td>
<td>0.27</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Algeria</td>
<td>2016</td>
<td>0.90</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Algeria</td>
<td>2019</td>
<td>0.60</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Andorra</td>
<td>1996</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="d." class="level3">
<h3 class="anchored" data-anchor-id="d.">1d.</h3>
<p>Filter the life expectancy data to include only the years that match the alcohol data (1996, 2016, 2019).</p>
<div id="cell-1d-World-Bank-Data-Filter-By-Year" class="cell" data-message="false" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>target_years <span class="op">=</span> [<span class="dv">1996</span>, <span class="dv">2016</span>, <span class="dv">2019</span>]</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"world_bank_df shape before year filter:"</span>, world_bank_df.shape)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>world_bank_df <span class="op">=</span> world_bank_df[world_bank_df[<span class="st">"year"</span>].isin(target_years)].copy()</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"world_bank_df shape after year filter:"</span>, world_bank_df.shape)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>display(world_bank_df.head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>world_bank_df shape before year filter: (14075, 5)
world_bank_df shape after year filter: (651, 5)</code></pre>
</div>
<div id="d-world-bank-data-filter-by-year" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">life_expectancy</th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">gdp_per_capita</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">36</th>
<td>Afghanistan</td>
<td>1996</td>
<td>52.830</td>
<td>17763266.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">56</th>
<td>Afghanistan</td>
<td>2016</td>
<td>62.646</td>
<td>34700612.0</td>
<td>522.082216</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">59</th>
<td>Afghanistan</td>
<td>2019</td>
<td>62.941</td>
<td>37856121.0</td>
<td>496.602504</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">101</th>
<td>Albania</td>
<td>1996</td>
<td>74.113</td>
<td>3168033.0</td>
<td>1020.976181</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">121</th>
<td>Albania</td>
<td>2016</td>
<td>78.643</td>
<td>2689469.0</td>
<td>4457.634122</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">124</th>
<td>Albania</td>
<td>2019</td>
<td>79.467</td>
<td>2567801.0</td>
<td>6069.439031</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">166</th>
<td>Algeria</td>
<td>1996</td>
<td>68.219</td>
<td>29033044.0</td>
<td>1616.831987</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">186</th>
<td>Algeria</td>
<td>2016</td>
<td>75.310</td>
<td>40850721.0</td>
<td>4424.985290</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">189</th>
<td>Algeria</td>
<td>2019</td>
<td>75.682</td>
<td>43294546.0</td>
<td>4468.453419</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">231</th>
<td>American Samoa</td>
<td>1996</td>
<td>71.576</td>
<td>53353.0</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="merge-these-datasets-by-country-name-and-year.-note-you-may-need-to-standardize-country-names-between-datasets-e.g.-united-states-vs-united-states-of-america." class="level3">
<h3 class="anchored" data-anchor-id="merge-these-datasets-by-country-name-and-year.-note-you-may-need-to-standardize-country-names-between-datasets-e.g.-united-states-vs-united-states-of-america.">Merge these datasets by country name and year. Note: You may need to standardize country names between datasets (e.g., “United States” vs “United States of America”).</h3>
<div id="country-name-inspection" class="cell" data-message="false" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: normalize country-name text formatting only (no mapping/merge yet)</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_country_name(series):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        series.astype(<span class="bu">str</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">str</span>.strip()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">str</span>.replace(<span class="vs">r"</span><span class="dv">\s</span><span class="op">+</span><span class="vs">"</span>, <span class="st">" "</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>world_bank_df[<span class="st">"country_std"</span>] <span class="op">=</span> normalize_country_name(world_bank_df[<span class="st">"country"</span>])</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>alcohol_long[<span class="st">"country_std"</span>] <span class="op">=</span> normalize_country_name(alcohol_long[<span class="st">"Country"</span>])</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"world_bank_df shape:"</span>, world_bank_df.shape)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"alcohol_long shape:"</span>, alcohol_long.shape)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Sample standardized country names (World Bank):"</span>)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>display(world_bank_df[[<span class="st">"country"</span>, <span class="st">"country_std"</span>]].drop_duplicates().head(<span class="dv">10</span>))</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sample standardized country names (Alcohol):"</span>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>display(alcohol_long[[<span class="st">"Country"</span>, <span class="st">"country_std"</span>]].drop_duplicates().head(<span class="dv">10</span>))</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: inspect unmatched standardized country names</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>wb_countries <span class="op">=</span> <span class="bu">set</span>(world_bank_df[<span class="st">"country_std"</span>].dropna().unique())</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>alcohol_countries <span class="op">=</span> <span class="bu">set</span>(alcohol_long[<span class="st">"country_std"</span>].dropna().unique())</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>wb_not_in_alcohol <span class="op">=</span> <span class="bu">sorted</span>(wb_countries <span class="op">-</span> alcohol_countries)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>alcohol_not_in_wb <span class="op">=</span> <span class="bu">sorted</span>(alcohol_countries <span class="op">-</span> wb_countries)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">World Bank names not found in alcohol data:"</span>, <span class="bu">len</span>(wb_not_in_alcohol))</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>display(pd.DataFrame({<span class="st">"wb_not_in_alcohol"</span>: wb_not_in_alcohol}).head(<span class="dv">60</span>))</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Alcohol names not found in World Bank data:"</span>, <span class="bu">len</span>(alcohol_not_in_wb))</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>display(pd.DataFrame({<span class="st">"alcohol_not_in_wb"</span>: alcohol_not_in_wb}).head(<span class="dv">60</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>world_bank_df shape: (651, 6)
alcohol_long shape: (573, 4)

Sample standardized country names (World Bank):</code></pre>
</div>
<div id="country-name-inspection-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">country_std</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">36</th>
<td>Afghanistan</td>
<td>Afghanistan</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">101</th>
<td>Albania</td>
<td>Albania</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">166</th>
<td>Algeria</td>
<td>Algeria</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">231</th>
<td>American Samoa</td>
<td>American Samoa</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">296</th>
<td>Andorra</td>
<td>Andorra</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">361</th>
<td>Angola</td>
<td>Angola</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">426</th>
<td>Antigua and Barbuda</td>
<td>Antigua and Barbuda</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">491</th>
<td>Argentina</td>
<td>Argentina</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">556</th>
<td>Armenia</td>
<td>Armenia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">621</th>
<td>Aruba</td>
<td>Aruba</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample standardized country names (Alcohol):</code></pre>
</div>
<div id="country-name-inspection-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Country</th>
<th data-quarto-table-cell-role="th">country_std</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Afghanistan</td>
<td>Afghanistan</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Albania</td>
<td>Albania</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Algeria</td>
<td>Algeria</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Andorra</td>
<td>Andorra</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>Angola</td>
<td>Angola</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>Antigua and Barbuda</td>
<td>Antigua and Barbuda</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>Argentina</td>
<td>Argentina</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>Armenia</td>
<td>Armenia</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>Australia</td>
<td>Australia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>Austria</td>
<td>Austria</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
World Bank names not found in alcohol data: 57</code></pre>
</div>
<div id="country-name-inspection-3" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">wb_not_in_alcohol</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>American Samoa</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Aruba</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Bahamas, The</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Bermuda</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>British Virgin Islands</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Brunei Darussalam</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Cabo Verde</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Cayman Islands</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Channel Islands</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Congo, Dem. Rep.</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>Congo, Rep.</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>Cote d'Ivoire</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>Curacao</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>Czechia</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>Egypt, Arab Rep.</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>Faroe Islands</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>French Polynesia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>Gambia, The</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>Gibraltar</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td>Greenland</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>Guam</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>Hong Kong SAR, China</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">22</th>
<td>Iran, Islamic Rep.</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td>Isle of Man</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>Korea, Dem. People's Rep.</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25</th>
<td>Korea, Rep.</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">26</th>
<td>Kosovo</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>Kyrgyz Republic</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">28</th>
<td>Lao PDR</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">29</th>
<td>Liechtenstein</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">30</th>
<td>Macao SAR, China</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">31</th>
<td>Marshall Islands</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">32</th>
<td>Micronesia, Fed. Sts.</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">33</th>
<td>Monaco</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">34</th>
<td>North Macedonia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">35</th>
<td>Northern Mariana Islands</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">36</th>
<td>Palau</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">37</th>
<td>Puerto Rico (US)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">38</th>
<td>Russian Federation</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">39</th>
<td>San Marino</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">40</th>
<td>Sao Tome and Principe</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">41</th>
<td>Sint Maarten (Dutch part)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">42</th>
<td>Slovak Republic</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">43</th>
<td>Somalia, Fed. Rep.</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">44</th>
<td>South Sudan</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">45</th>
<td>St. Kitts and Nevis</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">46</th>
<td>St. Lucia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">47</th>
<td>St. Martin (French part)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">48</th>
<td>St. Vincent and the Grenadines</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">49</th>
<td>Syrian Arab Republic</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">50</th>
<td>Turkiye</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">51</th>
<td>Turks and Caicos Islands</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">52</th>
<td>Venezuela, RB</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">53</th>
<td>Viet Nam</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">54</th>
<td>Virgin Islands (U.S.)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">55</th>
<td>West Bank and Gaza</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">56</th>
<td>Yemen, Rep.</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Alcohol names not found in World Bank data: 31</code></pre>
</div>
<div id="country-name-inspection-4" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">alcohol_not_in_wb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Bahamas</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Brunei</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Cape Verde</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Congo</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Cook Islands</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Czech Republic</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>DR Congo</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Egypt</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Gambia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Iran</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>Ivory Coast</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>Kyrgyzstan</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>Laos</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>Macedonia</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>Micronesia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>Netherlands Antilles</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>Niue</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>North Korea</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>Russia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td>Saint Kitts and Nevis</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>Saint Lucia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>Saint Vincent and the Grenadines</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">22</th>
<td>Slovakia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td>Somalia</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>South Korea</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25</th>
<td>Syria</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">26</th>
<td>São Tomé and Príncipe</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>Turkey</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">28</th>
<td>Venezuela</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">29</th>
<td>Vietnam</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">30</th>
<td>Yemen</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="country-name-standardization" class="cell" data-message="false" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual mapping for country mismatches</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>country_name_map <span class="op">=</span> {</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bahamas"</span>: <span class="st">"Bahamas, The"</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Brunei"</span>: <span class="st">"Brunei Darussalam"</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cape Verde"</span>: <span class="st">"Cabo Verde"</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Congo"</span>: <span class="st">"Congo, Rep."</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DR Congo"</span>: <span class="st">"Congo, Dem. Rep."</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Czech Republic"</span>: <span class="st">"Czechia"</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Egypt"</span>: <span class="st">"Egypt, Arab Rep."</span>,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Gambia"</span>: <span class="st">"Gambia, The"</span>,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Iran"</span>: <span class="st">"Iran, Islamic Rep."</span>,</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ivory Coast"</span>: <span class="st">"Cote d'Ivoire"</span>,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Kyrgyzstan"</span>: <span class="st">"Kyrgyz Republic"</span>,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Laos"</span>: <span class="st">"Lao PDR"</span>,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Macedonia"</span>: <span class="st">"North Macedonia"</span>,</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Micronesia"</span>: <span class="st">"Micronesia, Fed. Sts."</span>,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"North Korea"</span>: <span class="st">"Korea, Dem. People's Rep."</span>,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"South Korea"</span>: <span class="st">"Korea, Rep."</span>,</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Russia"</span>: <span class="st">"Russian Federation"</span>,</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Slovakia"</span>: <span class="st">"Slovak Republic"</span>,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Somalia"</span>: <span class="st">"Somalia, Fed. Rep."</span>,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Syria"</span>: <span class="st">"Syrian Arab Republic"</span>,</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Turkey"</span>: <span class="st">"Turkiye"</span>,</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Venezuela"</span>: <span class="st">"Venezuela, RB"</span>,</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Vietnam"</span>: <span class="st">"Viet Nam"</span>,</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Yemen"</span>: <span class="st">"Yemen, Rep."</span>,</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Saint Kitts and Nevis"</span>: <span class="st">"St. Kitts and Nevis"</span>,</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Saint Lucia"</span>: <span class="st">"St. Lucia"</span>,</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Saint Vincent and the Grenadines"</span>: <span class="st">"St. Vincent and the Grenadines"</span>,</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"São Tomé and Príncipe"</span>: <span class="st">"Sao Tome and Principe"</span>,</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply mapping on alcohol side to match World Bank naming</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>alcohol_long[<span class="st">"country_std"</span>] <span class="op">=</span> alcohol_long[<span class="st">"country_std"</span>].replace(country_name_map)</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-check unmatched names after manual mapping</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>wb_countries_after <span class="op">=</span> <span class="bu">set</span>(world_bank_df[<span class="st">"country_std"</span>].dropna().unique())</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>alcohol_countries_after <span class="op">=</span> <span class="bu">set</span>(alcohol_long[<span class="st">"country_std"</span>].dropna().unique())</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>wb_not_in_alcohol_after <span class="op">=</span> <span class="bu">sorted</span>(wb_countries_after <span class="op">-</span> alcohol_countries_after)</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>alcohol_not_in_wb_after <span class="op">=</span> <span class="bu">sorted</span>(alcohol_countries_after <span class="op">-</span> wb_countries_after)</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"After manual mapping:"</span>)</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"World Bank names not found in alcohol data:"</span>, <span class="bu">len</span>(wb_not_in_alcohol_after))</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>display(pd.DataFrame({<span class="st">"wb_not_in_alcohol_after"</span>: wb_not_in_alcohol_after}).head(<span class="dv">30</span>))</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Alcohol names not found in World Bank data:"</span>, <span class="bu">len</span>(alcohol_not_in_wb_after))</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>display(pd.DataFrame({<span class="st">"alcohol_not_in_wb_after"</span>: alcohol_not_in_wb_after}).head(<span class="dv">30</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>After manual mapping:
World Bank names not found in alcohol data: 29</code></pre>
</div>
<div id="country-name-standardization-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">wb_not_in_alcohol_after</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>American Samoa</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Aruba</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Bermuda</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>British Virgin Islands</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Cayman Islands</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Channel Islands</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Curacao</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Faroe Islands</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>French Polynesia</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Gibraltar</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>Greenland</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>Guam</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>Hong Kong SAR, China</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>Isle of Man</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>Kosovo</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>Liechtenstein</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>Macao SAR, China</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>Marshall Islands</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>Monaco</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td>Northern Mariana Islands</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>Palau</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>Puerto Rico (US)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">22</th>
<td>San Marino</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td>Sint Maarten (Dutch part)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>South Sudan</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25</th>
<td>St. Martin (French part)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">26</th>
<td>Turks and Caicos Islands</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>Virgin Islands (U.S.)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">28</th>
<td>West Bank and Gaza</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Alcohol names not found in World Bank data: 3</code></pre>
</div>
<div id="country-name-standardization-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">alcohol_not_in_wb_after</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Cook Islands</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Netherlands Antilles</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Niue</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-1-Datasets-Merging" class="cell" data-message="false" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Diagnostic merge: outer join to inspect what does/does not match</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>merged_outer <span class="op">=</span> world_bank_df.merge(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    alcohol_long,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"outer"</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span>[<span class="st">"country_std"</span>, <span class="st">"year"</span>],</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span>[<span class="st">"country_std"</span>, <span class="st">"Year"</span>],</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    indicator<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    suffixes<span class="op">=</span>(<span class="st">"_wb"</span>, <span class="st">"_alcohol"</span>),</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Outer merge shape:"</span>, merged_outer.shape)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Merge indicator counts:"</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(merged_outer[<span class="st">"_merge"</span>].value_counts())</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Analysis dataset: inner join keeps only matched country-year pairs</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>merged_df <span class="op">=</span> world_bank_df.merge(</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    alcohol_long,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span>,</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span>[<span class="st">"country_std"</span>, <span class="st">"year"</span>],</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span>[<span class="st">"country_std"</span>, <span class="st">"Year"</span>],</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    suffixes<span class="op">=</span>(<span class="st">"_wb"</span>, <span class="st">"_alcohol"</span>),</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep one country/year key and drop redundant merge columns</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>merged_df <span class="op">=</span> merged_df[</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"country_std"</span>,</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year"</span>,</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"life_expectancy"</span>,</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"population"</span>,</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gdp_per_capita"</span>,</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"alcohol_litres_per_capita_15plus"</span>,</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>merged_df <span class="op">=</span> merged_df.rename(columns<span class="op">=</span>{<span class="st">"country_std"</span>: <span class="st">"country"</span>})</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Inner merge shape (analysis dataset):"</span>, merged_df.shape)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>display(merged_df.head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Outer merge shape: (660, 10)
Merge indicator counts:
_merge
both          564
left_only      87
right_only      9
Name: count, dtype: int64

Inner merge shape (analysis dataset): (564, 6)</code></pre>
</div>
<div id="datasets-merging" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">life_expectancy</th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">gdp_per_capita</th>
<th data-quarto-table-cell-role="th">alcohol_litres_per_capita_15plus</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Afghanistan</td>
<td>1996</td>
<td>52.830</td>
<td>17763266.0</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Afghanistan</td>
<td>2016</td>
<td>62.646</td>
<td>34700612.0</td>
<td>522.082216</td>
<td>0.20</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Afghanistan</td>
<td>2019</td>
<td>62.941</td>
<td>37856121.0</td>
<td>496.602504</td>
<td>0.20</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Albania</td>
<td>1996</td>
<td>74.113</td>
<td>3168033.0</td>
<td>1020.976181</td>
<td>2.59</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Albania</td>
<td>2016</td>
<td>78.643</td>
<td>2689469.0</td>
<td>4457.634122</td>
<td>7.50</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Albania</td>
<td>2019</td>
<td>79.467</td>
<td>2567801.0</td>
<td>6069.439031</td>
<td>5.10</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Algeria</td>
<td>1996</td>
<td>68.219</td>
<td>29033044.0</td>
<td>1616.831987</td>
<td>0.27</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Algeria</td>
<td>2016</td>
<td>75.310</td>
<td>40850721.0</td>
<td>4424.985290</td>
<td>0.90</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Algeria</td>
<td>2019</td>
<td>75.682</td>
<td>43294546.0</td>
<td>4468.453419</td>
<td>0.60</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Andorra</td>
<td>1996</td>
<td>81.009</td>
<td>63984.0</td>
<td>19130.159715</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="conduct-basic-eda-on-the-merged-dataset-check-dimensions-missing-values-summary-statistics-of-key-variables-to-look-for-outliers.-which-countries-have-the-lowest-and-highest-life-expectancies-and-alcohol-consumption" class="level3">
<h3 class="anchored" data-anchor-id="conduct-basic-eda-on-the-merged-dataset-check-dimensions-missing-values-summary-statistics-of-key-variables-to-look-for-outliers.-which-countries-have-the-lowest-and-highest-life-expectancies-and-alcohol-consumption">Conduct basic EDA on the merged dataset: check dimensions, missing values, summary statistics of key variables to look for outliers. Which countries have the lowest and highest life expectancies and alcohol consumption?</h3>
<div id="eda-inspection" class="cell" data-message="false" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"shape:"</span>, merged_df.shape)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"n_rows:"</span>, merged_df.shape[<span class="dv">0</span>])</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"n_cols:"</span>, merged_df.shape[<span class="dv">1</span>])</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Unique countries:"</span>, merged_df[<span class="st">"country"</span>].nunique())</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>country_year_counts <span class="op">=</span> merged_df.groupby(<span class="st">"country"</span>)[<span class="st">"year"</span>].nunique()</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Unique year counts per country:"</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(country_year_counts.value_counts().sort_index())</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Missing values:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(merged_df.isna().<span class="bu">sum</span>())</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Missing percentage (%):</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>((merged_df.isna().mean() <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Summary statistics:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(merged_df.describe())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape: (564, 6)
n_rows: 564
n_cols: 6
Unique countries: 188

Unique year counts per country:
year
3    188
Name: count, dtype: int64


Missing values:

country                              0
year                                 0
life_expectancy                      0
population                           0
gdp_per_capita                       8
alcohol_litres_per_capita_15plus    43
dtype: int64

Missing percentage (%):

country                             0.00
year                                0.00
life_expectancy                     0.00
population                          0.00
gdp_per_capita                      1.42
alcohol_litres_per_capita_15plus    7.62
dtype: float64


Summary statistics:

              year  life_expectancy    population  gdp_per_capita  \
count   564.000000       564.000000  5.640000e+02      556.000000   
mean   2010.333333        69.804518  3.719581e+07    11283.244066   
std      10.217991         9.042869  1.378711e+08    16661.635359   
min    1996.000000        31.530000  9.342000e+03       71.406525   
25%    1996.000000        64.421250  2.006572e+06     1287.345659   
50%    2016.000000        71.236000  7.814162e+06     4125.174909   
75%    2019.000000        76.554848  2.577110e+07    13270.026950   
max    2019.000000        84.489000  1.407745e+09   112696.649060   

       alcohol_litres_per_capita_15plus  
count                        521.000000  
mean                           5.515355  
std                            4.128150  
min                            0.000000  
25%                            1.600000  
50%                            5.000000  
75%                            8.800000  
max                           17.000000  </code></pre>
</div>
</div>
<div id="drop-all-missing-rows" class="cell" data-message="false" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop all rows with any missing value (complete-case dataset)</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows before dropping missing rows:"</span>, merged_df.shape[<span class="dv">0</span>])</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows with any missing value:"</span>, merged_df.isna().<span class="bu">any</span>(axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">sum</span>())</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>dropped_rows <span class="op">=</span> merged_df[merged_df.isna().<span class="bu">any</span>(axis<span class="op">=</span><span class="dv">1</span>)].copy()</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>affected_countries <span class="op">=</span> <span class="bu">sorted</span>(dropped_rows[<span class="st">"country"</span>].dropna().unique())</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>merged_df_complete_case <span class="op">=</span> merged_df.dropna().copy()</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows after dropping all missing rows:"</span>, merged_df_complete_case.shape[<span class="dv">0</span>])</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Unique countries after drop:"</span>, merged_df_complete_case[<span class="st">"country"</span>].nunique())</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of affected countries:"</span>, <span class="bu">len</span>(affected_countries))</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Affected countries (had at least one dropped row):"</span>)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(affected_countries)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows before dropping missing rows: 564
Rows with any missing value: 49
Rows after dropping all missing rows: 515
Unique countries after drop: 187
Number of affected countries: 45
Affected countries (had at least one dropped row):
['Afghanistan', 'Andorra', 'Antigua and Barbuda', 'Bahamas, The', 'Bahrain', 'Bangladesh', 'Bhutan', 'Comoros', 'Dominica', 'Equatorial Guinea', 'Eritrea', 'Grenada', 'Iran, Islamic Rep.', 'Jordan', 'Kiribati', "Korea, Dem. People's Rep.", 'Kuwait', 'Libya', 'Mali', 'Mauritania', 'Micronesia, Fed. Sts.', 'Montenegro', 'Namibia', 'Nauru', 'Nepal', 'New Caledonia', 'Niger', 'Oman', 'Pakistan', 'Qatar', 'Samoa', 'Sao Tome and Principe', 'Saudi Arabia', 'Serbia', 'Seychelles', 'Sierra Leone', 'Somalia, Fed. Rep.', 'St. Kitts and Nevis', 'St. Lucia', 'St. Vincent and the Grenadines', 'Timor-Leste', 'Tonga', 'Tuvalu', 'United Kingdom', 'Yemen, Rep.']</code></pre>
</div>
</div>
<div id="eda-inspection-after-drop-all-missing-rows" class="cell" data-message="false" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"shape (after dropping all missing rows):"</span>, merged_df_complete_case.shape)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"n_rows:"</span>, merged_df_complete_case.shape[<span class="dv">0</span>])</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"n_cols:"</span>, merged_df_complete_case.shape[<span class="dv">1</span>])</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Unique countries:"</span>, merged_df_complete_case[<span class="st">"country"</span>].nunique())</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>country_year_counts_after_drop <span class="op">=</span> merged_df_complete_case.groupby(<span class="st">"country"</span>)[<span class="st">"year"</span>].nunique()</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Unique year counts per country:"</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(country_year_counts_after_drop.value_counts().sort_index())</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Missing values:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(merged_df_complete_case.isna().<span class="bu">sum</span>())</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Missing percentage (%):</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>((merged_df_complete_case.isna().mean() <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Summary statistics:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(merged_df_complete_case.describe())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>shape (after dropping all missing rows): (515, 6)
n_rows: 515
n_cols: 6
Unique countries: 187

Unique year counts per country:
year
1      2
2     42
3    143
Name: count, dtype: int64

Missing values:

country                             0
year                                0
life_expectancy                     0
population                          0
gdp_per_capita                      0
alcohol_litres_per_capita_15plus    0
dtype: int64

Missing percentage (%):

country                             0.0
year                                0.0
life_expectancy                     0.0
population                          0.0
gdp_per_capita                      0.0
alcohol_litres_per_capita_15plus    0.0
dtype: float64

Summary statistics:

              year  life_expectancy    population  gdp_per_capita  \
count   515.000000       515.000000  5.150000e+02      515.000000   
mean   2011.401942        70.198695  3.953295e+07    11678.334159   
std       9.780450         8.945520  1.438121e+08    17090.436805   
min    1996.000000        31.530000  1.058100e+04       71.406525   
25%    1996.000000        64.764500  2.457033e+06     1343.857976   
50%    2016.000000        71.540000  8.865631e+06     4170.114400   
75%    2019.000000        76.778402  2.807424e+07    14180.327188   
max    2019.000000        84.489000  1.407745e+09   112696.649060   

       alcohol_litres_per_capita_15plus  
count                        515.000000  
mean                           5.553670  
std                            4.133556  
min                            0.000000  
25%                            1.600000  
50%                            5.100000  
75%                            8.875000  
max                           17.000000  </code></pre>
</div>
</div>
<div id="eda-outliers" class="cell" data-message="false" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show which country/year achieves each extremum</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_extremum_context(df, value_col, label):</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    min_idx <span class="op">=</span> df[value_col].idxmin()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    max_idx <span class="op">=</span> df[value_col].idxmax()</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    min_row <span class="op">=</span> df.loc[min_idx, [<span class="st">"country"</span>, <span class="st">"year"</span>, value_col]]</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    max_row <span class="op">=</span> df.loc[max_idx, [<span class="st">"country"</span>, <span class="st">"year"</span>, value_col]]</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> minimum at:"</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(min_row)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> maximum at:"</span>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(max_row)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>print_extremum_context(merged_df_complete_case, <span class="st">"life_expectancy"</span>, <span class="st">"Life expectancy"</span>)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>print_extremum_context(merged_df_complete_case, <span class="st">"alcohol_litres_per_capita_15plus"</span>, <span class="st">"Alcohol consumption"</span>)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>print_extremum_context(merged_df_complete_case, <span class="st">"gdp_per_capita"</span>, <span class="st">"GDP per capita"</span>)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>print_extremum_context(merged_df_complete_case, <span class="st">"population"</span>, <span class="st">"Population"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Life expectancy minimum at:
country            Central African Republic
year                                   2019
life_expectancy                       31.53
Name: 98, dtype: object
Life expectancy maximum at:
country            Andorra
year                  2016
life_expectancy     84.489
Name: 10, dtype: object

Alcohol consumption minimum at:
country                             Bangladesh
year                                      2016
alcohol_litres_per_capita_15plus           0.0
Name: 40, dtype: object
Alcohol consumption maximum at:
country                             Romania
year                                   2019
alcohol_litres_per_capita_15plus       17.0
Name: 416, dtype: object

GDP per capita minimum at:
country             Liberia
year                   1996
gdp_per_capita    71.406525
Name: 291, dtype: object
GDP per capita maximum at:
country             Luxembourg
year                      2019
gdp_per_capita    112696.64906
Name: 302, dtype: object

Population minimum at:
country        Tuvalu
year             2019
population    10581.0
Name: 524, dtype: object
Population maximum at:
country              China
year                  2019
population    1407745000.0
Name: 107, dtype: object</code></pre>
</div>
</div>
<p><strong>Summary:</strong></p>
<ul>
<li><strong>Minimum Life expectancy:</strong> approximately 31.53 years in Central African Republic (2019).</li>
<li><strong>Maximum Life expectancy:</strong> approximately 84.49 years in Andorra (2016).</li>
<li><strong>Minimum Annual Pure Alcohol consumption:</strong> approximately 0.00 liters per person (age 15+) in Bangladesh (2016).</li>
<li><strong>Maximum Annual Pure Alcohol consumption:</strong> approximately 17.00 liters per person (age 15+) in Romania (2019).</li>
</ul>
</section>
<section id="write-a-paragraph-describing-your-scraping-and-cleaning-steps.-include-a-written-summary-of-the-variables-and-the-number-of-observations-before-and-after-merging.-document-any-countries-that-didnt-match-and-how-you-handled-them.-also-summarize-your-findings-from-the-basic-eda." class="level3">
<h3 class="anchored" data-anchor-id="write-a-paragraph-describing-your-scraping-and-cleaning-steps.-include-a-written-summary-of-the-variables-and-the-number-of-observations-before-and-after-merging.-document-any-countries-that-didnt-match-and-how-you-handled-them.-also-summarize-your-findings-from-the-basic-eda.">Write a paragraph describing your scraping and cleaning steps. Include a written summary of the variables and the number of observations before and after merging. Document any countries that didn’t match and how you handled them. Also summarize your findings from the basic EDA.</h3>
<p><strong>Solution:</strong></p>
<p>First, I pulled life expectancy, population, and GDP per capita data from the World Bank API (with the support of the API documentation) by parsing the nested JSON into tidy <code>country</code>–<code>year</code>–<code>indicator</code> tables, with filtering out aggregate regions using the API’s country metadata by checking the flag of “Aggregates”, which indicates this row’s data is not for a country, but for a region or group, dropping missing indicator values, and merging the three indicators by country and year through outer joins before restricting to the target years-1996, 2016, and 2019.</p>
<p>Second, I scraped alcohol consumption data from Wikipedia (use provided link) by using lab05 workflow and codes, with removing footnote markers from headers and country names, converting the year column to integer, treating dashed entries as missing values (NaN), and reshaping the dataset to long format with <code>pd.melt()</code>.</p>
<p>After that, I standardized country names by trimming whitespace and applying a manual mapping dictionary to make sure the country names in the two datasets are consistent and follow the World Bank naming conventions. (See the mapping details below)</p>
<p>Finally, I merged the two datasets by standardized country names and year to get the final dataset. The merged dataset contains the following variables:</p>
<ul>
<li><code>country</code> (standardized country name following World Bank conventions),</li>
<li><code>year</code> (1996/2016/2019),</li>
<li><code>life_expectancy</code> (years),</li>
<li><code>population</code> (total),</li>
<li><code>gdp_per_capita</code> (current US$), and</li>
<li><code>alcohol_litres_per_capita_15plus</code> (litres of annual pure alcohol consumption per person age 15+).</li>
</ul>
<p>Before merging, the World Bank dataset contained <strong>651</strong> observations and the alcohol dataset contained <strong>573</strong> observations (after cleaning). After merging through inner join by <code>country</code> and <code>year</code>, the final merged dataset contained <strong>564</strong> observations. The reason of using inner join is to keep only the matched <code>country</code>-<code>year</code> pairs. The unmatched <code>country</code>-<code>year</code> pairs after the country names were standardized (such as Monaco, appears in World Bank dataset but not in Alchohol dataset) were dropped because they are the mismatch between the two datasets. <strong>A groupby validation (<code>merged_df.groupby("country")["year"].nunique()</code>) confirms that in this merged dataset each country appears in all three target years (1996, 2016, and 2019).</strong> Therefore, the accuracy of future analysis is maintained.</p>
<p>There is no missing value in <code>life_expectancy</code> or <code>population</code>, but some missingness is in <code>gdp_per_capita</code> (8 rows; 1.42%) and <code>alcohol_litres_per_capita_15plus</code> (43 rows; 7.62%). Therefore, I dropped all rows with any missing values to create a complete-case dataset (<code>merged_df_complete_case</code>) for downstream summaries and comparisons. Therefore, there are <strong>515</strong> observations in the complete-case dataset. After handling missing values, the observed ranges are calculated:</p>
<ul>
<li>Life expectancy from 31.53 years (Central African Republic, 2019) to 84.49 years (Andorra, 2016)</li>
<li>Annual pure alcohol consumption per person age 15+ from 0.00 liters (Bangladesh, 2016) to 17.0 liters (Romania, 2019)</li>
<li>GDP per capita from 71.41 USD (Liberia, 1996) to 112,696.65 USD (Luxembourg, 2019)</li>
<li>Population from 9,342 (Tuvalu, 1996) to about 1.41 billion (China, 2019)</li>
</ul>
<p>Accroding to the summary statistics, some countries have extreme values in the variables, especially for GDP per capita. After validate some of the extreme values, I found that they are reasonable and not due to data entry errors. For example, Luxembourg’s peak GDP per capita is an accurate reflection of real-world scenarios.</p>
<p><strong>Mapping Reference during Standardization:</strong></p>
<p>The following manual country name mappings during standardization were applied to align the Wikipedia alcohol dataset with World Bank naming conventions (Alcohol dataset country name → World Bank dataset country name):</p>
<ul>
<li>Bahamas → Bahamas, The<br>
</li>
<li>Brunei → Brunei Darussalam<br>
</li>
<li>Cape Verde → Cabo Verde<br>
</li>
<li>Congo → Congo, Rep.<br>
</li>
<li>DR Congo → Congo, Dem. Rep.<br>
</li>
<li>Czech Republic → Czechia<br>
</li>
<li>Egypt → Egypt, Arab Rep.<br>
</li>
<li>Gambia → Gambia, The<br>
</li>
<li>Iran → Iran, Islamic Rep.<br>
</li>
<li>Ivory Coast → Cote d’Ivoire<br>
</li>
<li>Kyrgyzstan → Kyrgyz Republic<br>
</li>
<li>Laos → Lao PDR<br>
</li>
<li>Macedonia → North Macedonia<br>
</li>
<li>Micronesia → Micronesia, Fed. Sts.<br>
</li>
<li>North Korea → Korea, Dem. People’s Rep.<br>
</li>
<li>South Korea → Korea, Rep.<br>
</li>
<li>Russia → Russian Federation<br>
</li>
<li>Slovakia → Slovak Republic<br>
</li>
<li>Somalia → Somalia, Fed. Rep.<br>
</li>
<li>Syria → Syrian Arab Republic<br>
</li>
<li>Turkey → Turkiye<br>
</li>
<li>Venezuela → Venezuela, RB<br>
</li>
<li>Vietnam → Viet Nam<br>
</li>
<li>Yemen → Yemen, Rep.<br>
</li>
<li>Saint Kitts and Nevis → St.&nbsp;Kitts and Nevis<br>
</li>
<li>Saint Lucia → St.&nbsp;Lucia<br>
</li>
<li>Saint Vincent and the Grenadines → St.&nbsp;Vincent and the Grenadines<br>
</li>
<li>São Tomé and Príncipe → Sao Tome and Principe</li>
</ul>
</section>
</section>
<section id="points-create-a-summary-table-of-the-merged-dataset-showing-the-mean-and-sd-of-life-expectancy-alcohol-consumption-population-and-gdp-per-capita-by-year.-briefly-summarize." class="level2">
<h2 class="anchored" data-anchor-id="points-create-a-summary-table-of-the-merged-dataset-showing-the-mean-and-sd-of-life-expectancy-alcohol-consumption-population-and-gdp-per-capita-by-year.-briefly-summarize.">2. (4 points) Create a summary table of the merged dataset showing the mean and sd of life expectancy, alcohol consumption, population, and GDP per capita by year. Briefly summarize.</h2>
<div id="cell-2-Summary-Table" class="cell" data-message="false" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>summary_table <span class="op">=</span> (</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    merged_df_complete_case</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year"</span>)[[<span class="st">"life_expectancy"</span>, <span class="st">"alcohol_litres_per_capita_15plus"</span>, <span class="st">"population"</span>, <span class="st">"gdp_per_capita"</span>]]</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">"mean"</span>, <span class="st">"std"</span>])</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten column names for readability</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>summary_table.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>stat<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> var, stat <span class="kw">in</span> summary_table.columns]</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>summary_table <span class="op">=</span> summary_table.reset_index()</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>display(summary_table)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="summary-table" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">life_expectancy_mean</th>
<th data-quarto-table-cell-role="th">life_expectancy_std</th>
<th data-quarto-table-cell-role="th">alcohol_litres_per_capita_15plus_mean</th>
<th data-quarto-table-cell-role="th">alcohol_litres_per_capita_15plus_std</th>
<th data-quarto-table-cell-role="th">population_mean</th>
<th data-quarto-table-cell-role="th">population_std</th>
<th data-quarto-table-cell-role="th">gdp_per_capita_mean</th>
<th data-quarto-table-cell-role="th">gdp_per_capita_std</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1996</td>
<td>65.766</td>
<td>9.820</td>
<td>4.855</td>
<td>4.274</td>
<td>3.598496e+07</td>
<td>1.319311e+08</td>
<td>6795.270</td>
<td>10828.240</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2016</td>
<td>71.633</td>
<td>7.867</td>
<td>6.184</td>
<td>4.108</td>
<td>4.024900e+07</td>
<td>1.466055e+08</td>
<td>12810.489</td>
<td>17795.480</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2019</td>
<td>72.274</td>
<td>8.002</td>
<td>5.474</td>
<td>3.968</td>
<td>4.162826e+07</td>
<td>1.505760e+08</td>
<td>14414.632</td>
<td>19525.001</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong>Summary:</strong></p>
<ul>
<li><strong>Life expectancy:</strong> increased from 1996 to 2019 (mean rose by 6.5 years overall), while the cross-country variation was large (sd was approximately 8–10 years).</li>
<li>The average <strong>Annual Pure Alcohol consumption per person age 15+</strong> increased from 1996 to 2016, then decreased by 2019; variation across countries was approximately constant over years, but extremely high since the sd was close to the means.</li>
<li><strong>GDP per capita:</strong> increased strongly over time, and the sd was larger than the mean in every year, indicating substantial inequality across countries.</li>
<li><strong>Population:</strong> mean population increased over time, but the very large sd reflects the mix of very small and very large countries in terms of population.</li>
</ul>
</section>
<section id="points-create-a-new-categorical-variable-named-gdp_level-using-the-gdp-per-capita-variable.-calculate-the-quartiles-of-gdp-per-capita.-categorize-gdp-level-as-low-0-q1-medium-q1-q3-and-high-q3.-to-make-sure-the-variable-is-correctly-coded-create-a-summary-table-that-contains-the-minimum-gdp-per-capita-maximum-gdp-per-capita-and-number-of-observations-for-each-category." class="level2">
<h2 class="anchored" data-anchor-id="points-create-a-new-categorical-variable-named-gdp_level-using-the-gdp-per-capita-variable.-calculate-the-quartiles-of-gdp-per-capita.-categorize-gdp-level-as-low-0-q1-medium-q1-q3-and-high-q3.-to-make-sure-the-variable-is-correctly-coded-create-a-summary-table-that-contains-the-minimum-gdp-per-capita-maximum-gdp-per-capita-and-number-of-observations-for-each-category.">3. (4 points) Create a new categorical variable named “gdp_level” using the GDP per capita variable. Calculate the quartiles of GDP per capita. Categorize GDP level as low (0-q1), medium (q1-q3), and high (q3+). To make sure the variable is correctly coded, create a summary table that contains the minimum GDP per capita, maximum GDP per capita, and number of observations for each category.</h2>
</section>
</section>
<section id="visualization" class="level1">
<h1>Visualization</h1>
<section id="points-create-the-following-figures-with-plotnine-and-interpret-them.-be-sure-to-include-easily-understandable-axes-titles-and-legends." class="level2">
<h2 class="anchored" data-anchor-id="points-create-the-following-figures-with-plotnine-and-interpret-them.-be-sure-to-include-easily-understandable-axes-titles-and-legends.">4. (15 points) Create the following figures with plotnine and interpret them. Be sure to include easily understandable axes, titles, and legends.</h2>
<section id="a.-1" class="level3">
<h3 class="anchored" data-anchor-id="a.-1">4a.</h3>
<p>Two line plots: one of life expectancy by year and the other of alcohol consumption by year with lines for Canada and 3 other contrasting countries.</p>
</section>
<section id="b.-1" class="level3">
<h3 class="anchored" data-anchor-id="b.-1">4b.</h3>
<p>Facet plot by year for 1996, 2016, and 2019 showing scatterplots with linear and lowess regression lines of life expectancy and alcohol consumption. regression lines of life expectancy and alcohol consumption.</p>
</section>
<section id="c.-1" class="level3">
<h3 class="anchored" data-anchor-id="c.-1">4c.</h3>
<p>Facet plot by year for 1996, 2016, and 2019 showing boxplots of alcohol consumption by GDP level.</p>
</section>
<section id="d.-1" class="level3">
<h3 class="anchored" data-anchor-id="d.-1">4d.</h3>
<p>A barplot showing life expectancy in 1996 and 2019 for the 10 countries with the largest change in life expectancy between 1996 and 2019. change in life expectancy between 1996 and 2019.</p>
</section>
<section id="e." class="level3">
<h3 class="anchored" data-anchor-id="e.">4e.</h3>
<p>Come up with your own plot that will help to understand the role of GDP in the association between alcohol and life expectancy.</p>
</section>
</section>
</section>
<section id="advanced-regression" class="level1">
<h1>Advanced Regression</h1>
<section id="points-construct-a-multiple-linear-regression-model-to-examine-the-association-between-life-expectancy-and-alcohol-consumption-adjusted-for-gdp-per-capita-and-year.-note-you-should-scale-gdp-by-population-to-get-gdp-per-capita-since-the-values-can-be-very-large.-then-fit-a-gam-model-where-you-put-a-smooth-on-gdp-per-capita-and-alcohol-consumption.provide-the-following-in-your-analyses" class="level2">
<h2 class="anchored" data-anchor-id="points-construct-a-multiple-linear-regression-model-to-examine-the-association-between-life-expectancy-and-alcohol-consumption-adjusted-for-gdp-per-capita-and-year.-note-you-should-scale-gdp-by-population-to-get-gdp-per-capita-since-the-values-can-be-very-large.-then-fit-a-gam-model-where-you-put-a-smooth-on-gdp-per-capita-and-alcohol-consumption.provide-the-following-in-your-analyses">5. (8 points) Construct a multiple linear regression model to examine the association between life expectancy and alcohol consumption adjusted for GDP per capita, and year. Note you should scale GDP by population to get GDP per capita since the values can be very large. Then fit a gam model where you put a smooth on GDP per capita and alcohol consumption.Provide the following in your analyses:</h2>
<section id="a.-2" class="level3">
<h3 class="anchored" data-anchor-id="a.-2">5a.</h3>
<p>Summaries of your models, including overall model fit and interpretation of the parameter estimates (linear and non-linear).</p>
</section>
<section id="b.-2" class="level3">
<h3 class="anchored" data-anchor-id="b.-2">5b.</h3>
<p>Plot of the smoothed variables from the gam model and interpret.</p>
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W119
</script>
<div id="exercise-loading-indicator" class="exercise-loading-indicator d-none d-flex align-items-center gap-2">
<div id="exercise-loading-status" class="d-flex gap-2">

</div>
<div class="spinner-grow spinner-grow-sm">

</div>
</div>
<script type="vfs-file">
W10=
</script>
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W119
</script>
<div id="exercise-loading-indicator" class="exercise-loading-indicator d-none d-flex align-items-center gap-2">
<div id="exercise-loading-status" class="d-flex gap-2">

</div>
<div class="spinner-grow spinner-grow-sm">

</div>
</div>
<script type="vfs-file">
W10=
</script>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W119
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../../..";
window._ojs.paths.runtimeToRoot = "../../../../..";
window._ojs.paths.docToRoot = "../..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>