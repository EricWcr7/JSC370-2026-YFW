---
title: "Homework 2 — Data Scraping, APIs and Advanced Regression"
subtitle: "JSC370 (Winter 2026)"
author: "Yi Fan (Eric) Wang"
date: "February 14, 2026"
format:
  live-html:
    toc: true
    page-layout: full
filters:
  - r-wasm/live
jupyter: python3
execute:
  enabled: true
  echo: true
  warning: false
  message: false
---

# Learning Goals

- Use an API, scrape, wrangle, and get familiar different datasets.
- Make visualizations
- Conduct GAM regression modeling and compare to linear regression

# Assignment Description

For this assignment, we will be analyzing data on life expectancy and alcohol consumption.
The learning objectives are to conduct data wrangling and visualization keeping key questions
in mind. We will also do a regression analysis.

The primary questions of interest are:

- Is there an association between life expectancy and alcohol consumption?
- How have life expectancy and alcohol consumption changed over time?
- Do other country specific factors such as per capita gross domestic product or population
play a role in the relationship between alcohol consumption and life expectancy?

# Environment Setup

```{python}
#| label: environment-setup
#| message: false
#| warning: false

import re
import requests
import numpy as np
import pandas as pd

```

# Data Acquisition and Wrangling

## 1. (15 points) Obtain two datasets: life expectancy (via API) and alcohol consumption (via web scraping).

For life expectancy, population, and GDP: Use the World Bank API to fetch the following
indicators:

- SP.DYN.LE00.IN - Life expectancy at birth, total (years)
- SP.POP.TOTL - Population, total
- NY.GDP.PCAP.CD - GDP per capita (current US$)

You will need to:

- Parse the nested JSON response into a clean DataFrame for each indicator
- Handle missing values and filter to relevant years (1996, 2016, 2019)
- Note: The API returns data for regions/aggregates as well as countries; you may want to
filter these out
- Merge the three indicators together by country and year

See the World Bank API documentation for more details on available endpoints and filtering
options.

For alcohol consumption: Use web scraping to extract the historical consumption table
(with data for 1996, 2016, and 2019) from the Wikipedia page on alcohol consumption
per capita.

**Before merging, prepare both datasets as follows:**

### 1a.
World Bank API data: Parse the JSON responses from the World Bank API into DataFrames. The API response contains nested dictionaries with fields like country, date, and value. Extract the relevant fields into clean DataFrames for each indicator (life expectancy, population, and GDP per capita), then merge them together by country and year.

```{python}
#| label: world-bank-api-data
#| message: false
#| warning: false

BASE_URL = "https://api.worldbank.org/v2/country/all/indicator"
COUNTRY_META_URL = "https://api.worldbank.org/v2/country"

INDICATORS = {
    "life_expectancy": "SP.DYN.LE00.IN",
    "population": "SP.POP.TOTL",
    "gdp_per_capita": "NY.GDP.PCAP.CD",
}


def get_world_bank_pages(indicator_code):
    """
    Fetch all pages for one World Bank indicator.
    Returns a list of raw records from the JSON response.
    """
    indicator_url = f"{BASE_URL}/{indicator_code}"
    page = 1
    all_records = []

    while True:
        params = {
            "format": "json",
            "per_page": 20000,
            "page": page,
        }
        response = requests.get(indicator_url, params=params, timeout=30)
        response.raise_for_status()
        payload = response.json()

        # JSON structure: payload[0] = metadata, payload[1] = records
        metadata = payload[0]
        records = payload[1]
        all_records.extend(records)

        if page >= int(metadata["pages"]):
            break
        page += 1

    return all_records


def get_country_metadata():
    """
    Fetch country metadata.
    """
    page = 1
    all_countries = []

    while True:
        params = {
            "format": "json",
            "per_page": 400,
            "page": page,
        }
        response = requests.get(COUNTRY_META_URL, params=params, timeout=30)
        response.raise_for_status()
        payload = response.json()

        metadata = payload[0]
        rows = payload[1]
        all_countries.extend(rows)

        if page >= int(metadata["pages"]):
            break
        page += 1

    countries_df = pd.DataFrame(all_countries)
    countries_df["region_name"] = countries_df["region"].apply(lambda x: x.get("value") if isinstance(x, dict) else np.nan)
    return countries_df


def parse_indicator_records(records, value_name):
    """
    Parse nested JSON fields and keep relevant columns.
    """
    df = pd.DataFrame(records)

    # Extract nested values from API response
    df["country"] = df["country"].apply(lambda x: x.get("value") if isinstance(x, dict) else np.nan)
    df["year"] = pd.to_numeric(df["date"], errors="coerce")
    df[value_name] = pd.to_numeric(df["value"], errors="coerce")
    df = df[["countryiso3code", "country", "year", value_name]].copy()
    return df.reset_index(drop=True)


# 1) Fetch and parse indicator data
life_records = get_world_bank_pages(INDICATORS["life_expectancy"])
pop_records = get_world_bank_pages(INDICATORS["population"])
gdp_records = get_world_bank_pages(INDICATORS["gdp_per_capita"])
life_expectancy_raw = parse_indicator_records(life_records, "life_expectancy")
population_raw = parse_indicator_records(pop_records, "population")
gdp_per_capita_raw = parse_indicator_records(gdp_records, "gdp_per_capita")

# 2) Build official non-aggregate country list from metadata
countries_df = get_country_metadata()
valid_iso3 = set(countries_df.loc[countries_df["region_name"] != "Aggregates", "id"].dropna())

# 3) Aggregate Checks before removing aggregates
print("Rows before removing aggregates:")
print("life_expectancy_raw:", len(life_expectancy_raw))
print("population_raw:", len(population_raw))
print("gdp_per_capita_raw:", len(gdp_per_capita_raw))

life_aggregate_rows = life_expectancy_raw[~life_expectancy_raw["countryiso3code"].isin(valid_iso3)].copy()
life_aggregate_pairs = life_aggregate_rows[["countryiso3code", "country"]].drop_duplicates()
print("Unique (countryiso3code, country) aggregate pairs in life data:", life_aggregate_pairs.shape[0])
print("Aggregate rows before filtering (all years/values) in life data:", life_aggregate_rows.shape[0])
display(life_aggregate_pairs.head(10))

all_raw = pd.concat(
    [
        life_expectancy_raw[["countryiso3code", "country"]],
        population_raw[["countryiso3code", "country"]],
        gdp_per_capita_raw[["countryiso3code", "country"]],
    ],
    ignore_index=True,
).drop_duplicates()
all_aggregate_names_in_original_data = sorted(
    all_raw.loc[~all_raw["countryiso3code"].isin(valid_iso3), "country"].dropna().unique()
)
print("All aggregate/group names in original fetched data:", len(all_aggregate_names_in_original_data))
display(pd.DataFrame({"aggregate_name_in_original_data": all_aggregate_names_in_original_data}))

# 4) Remove aggregates
life_expectancy_raw = life_expectancy_raw[life_expectancy_raw["countryiso3code"].isin(valid_iso3)].copy()
population_raw = population_raw[population_raw["countryiso3code"].isin(valid_iso3)].copy()
gdp_per_capita_raw = gdp_per_capita_raw[gdp_per_capita_raw["countryiso3code"].isin(valid_iso3)].copy()

print("Rows after removing aggregates:")
print("life_expectancy_raw:", len(life_expectancy_raw))
print("population_raw:", len(population_raw))
print("gdp_per_capita_raw:", len(gdp_per_capita_raw))
print("Sample rows after removing aggregates:")
print("life_expectancy_raw:")
display(life_expectancy_raw.head())
print("population_raw:")
display(population_raw.head())
print("gdp_per_capita_raw:")
display(gdp_per_capita_raw.head())
```

```{python}
#| label: world-bank-handling-missing-values
#| message: false
#| warning: false

# Check missing values (Lab 3 style: inspect first, then drop)
print("Missing values before handling:")
print("life_expectancy_raw:")
print(life_expectancy_raw[["countryiso3code", "country", "year", "life_expectancy"]].isna().sum())
print("population_raw:")
print(population_raw[["countryiso3code", "country", "year", "population"]].isna().sum())
print("gdp_per_capita_raw:")
print(gdp_per_capita_raw[["countryiso3code", "country", "year", "gdp_per_capita"]].isna().sum())

# Drop rows with missing key fields / indicator values
life_expectancy_df = life_expectancy_raw.dropna(
    subset=["countryiso3code", "country", "year", "life_expectancy"]
).copy()
population_df = population_raw.dropna(
    subset=["countryiso3code", "country", "year", "population"]
).copy()
gdp_per_capita_df = gdp_per_capita_raw.dropna(
    subset=["countryiso3code", "country", "year", "gdp_per_capita"]
).copy()

# Keep year as integer after dropping missing values
life_expectancy_df["year"] = life_expectancy_df["year"].astype(int)
population_df["year"] = population_df["year"].astype(int)
gdp_per_capita_df["year"] = gdp_per_capita_df["year"].astype(int)

print("Rows after missing-value handling:")
print("life_expectancy_df:", life_expectancy_df.shape)
print("population_df:", population_df.shape)
print("gdp_per_capita_df:", gdp_per_capita_df.shape)
```

```{python}
#| label: world-bank-merge-data
#| message: false
#| warning: false

# 1) Merge life expectancy with population
world_bank_df = life_expectancy_df.merge(
    population_df,
    how="outer",
    on=["country", "year"],
)

# 2) Merge in GDP per capita
world_bank_df = world_bank_df.merge(
    gdp_per_capita_df,
    how="outer",
    on=["country", "year"],
)

# 3) Sort for readability
world_bank_df = world_bank_df.sort_values(["country", "year"]).reset_index(drop=True)

# 4) Merge summary (Lab 5 style)
print(f"life_expectancy_df rows: {len(life_expectancy_df)}")
print(f"population_df rows: {len(population_df)}")
print(f"gdp_per_capita_df rows: {len(gdp_per_capita_df)}")
print(f"Merged world_bank_df shape: {world_bank_df.shape}")
display(world_bank_df.head(10))
```

### 1b.
Alcohol (scraped data): Identify which Wikipedia table contains the historical data (1996, 2016, 2019) and extract it. Clean the scraped data: remove any footnote markers (e.g., [1]), convert columns to appropriate data types, and handle any missing values.

### 1c.
Reshape the alcohol data from wide to long format, creating a “Year” column with values 1996, 2016, and 2019. You can use pd.melt() in Python.

### 1d.
Filter the life expectancy data to include only the years that match the alcohol data (1996, 2016, 2019).

### Merge these datasets by country name and year. Note: You may need to standardize country names between datasets (e.g., “United States” vs “United States of America”).

### Conduct basic EDA on the merged dataset: check dimensions, missing values, summary statistics of key variables to look for outliers. Which countries have the lowest and highest life expectancies and alcohol consumption?

### Write a paragraph describing your scraping and cleaning steps. Include a written summary of the variables and the number of observations before and after merging. Document any countries that didn’t match and how you handled them. Also summarize your findings from the basic EDA.

## 2. (4 points) Create a summary table of the merged dataset showing the mean and sd of life expectancy, alcohol consumption, population, and GDP per capita by year. Briefly summarize.

## 3. (4 points) Create a new categorical variable named “gdp_level” using the GDP per capita variable. Calculate the quartiles of GDP per capita. Categorize GDP level as low (0-q1), medium (q1-q3), and high (q3+). To make sure the variable is correctly coded, create a summary table that contains the minimum GDP per capita, maximum GDP per capita, and number of observations for each category.

# Visualization

## 4. (15 points) Create the following figures with plotnine and interpret them. Be sure to include easily understandable axes, titles, and legends.

### 4a.
Two line plots: one of life expectancy by year and the other of alcohol consumption by year with lines for Canada and 3 other contrasting countries.

### 4b.
Facet plot by year for 1996, 2016, and 2019 showing scatterplots with linear and lowess regression lines of life expectancy and alcohol consumption. regression lines of life expectancy and alcohol consumption.

### 4c.
Facet plot by year for 1996, 2016, and 2019 showing boxplots of alcohol consumption by GDP level.

### 4d.
A barplot showing life expectancy in 1996 and 2019 for the 10 countries with the largest change in life expectancy between 1996 and 2019. change in life expectancy between 1996 and 2019.

### 4e.
Come up with your own plot that will help to understand the role of GDP in the association between alcohol and life expectancy.

# Advanced Regression

## 5. (8 points) Construct a multiple linear regression model to examine the association between life expectancy and alcohol consumption adjusted for GDP per capita, and year. Note you should scale GDP by population to get GDP per capita since the values can be very large. Then fit a gam model where you put a smooth on GDP per capita and alcohol consumption.Provide the following in your analyses:

### 5a.
Summaries of your models, including overall model fit and interpretation of the parameter estimates (linear and non-linear).

### 5b.
Plot of the smoothed variables from the gam model and interpret.

